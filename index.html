<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Natal Fam√≠lia 2026</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÖ</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- √çcones -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Calend√°rio -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>


    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0f172a; /* Slate 900 */
            color: #f1f5f9; /* Slate 100 */
        }

        /* ===========================================================
           LOGIN
           =========================================================== */
        #loginOverlay { isolation: isolate; }
        #loginOverlay .login-bg{
            background:
                radial-gradient(1200px circle at 20% 20%, rgba(99, 102, 241, 0.25), transparent 55%),
                radial-gradient(1200px circle at 85% 15%, rgba(16, 185, 129, 0.18), transparent 55%),
                radial-gradient(900px circle at 50% 85%, rgba(236, 72, 153, 0.18), transparent 55%),
                linear-gradient(180deg, rgba(2, 6, 23, 1) 0%, rgba(15, 23, 42, 1) 100%);
        }
        #loginOverlay .login-topline{
            background: linear-gradient(90deg, #ec4899, #6366f1, #10b981);
        }


        .card {
            background-color: #1e293b; /* Slate 800 */
            border: 1px solid #334155; /* Slate 700 */
            border-radius: 0.75rem;
            padding: 1.5rem;
        }

        .tab-btn { 
            padding: 0.5rem 1rem; 
            border-radius: 0.5rem; 
            font-size: 0.875rem; 
            font-weight: 500; 
            color: #94a3b8; 
            transition: all 0.2s;
        }
        .tab-btn:hover { color: white; background-color: #334155; }
        .tab-btn.active { background-color: #4f46e5; color: white; }

        /* Scrollbar da tabela */
        ::-webkit-scrollbar { height: 8px; width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Badges de Status (Cores Din√¢micas) */
        .status-badge {
            font-size: 0.75rem; 
            font-weight: 600; 
            padding: 2px 0; 
            width: 100%; 
            display: block; 
            border-radius: 4px; 
            text-align: center;
        }
        
        /* Regras de Cores */
        .bg-paid { background-color: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.2); } /* Verde */
        .bg-partial { background-color: rgba(250, 204, 21, 0.15); color: #facc15; border: 1px solid rgba(250, 204, 21, 0.2); } /* Amarelo */
        .bg-missed { background-color: rgba(248, 113, 113, 0.15); color: #f87171; border: 1px solid rgba(248, 113, 113, 0.2); } /* Vermelho */
        .bg-none { background-color: rgba(148, 163, 184, 0.1); color: #94a3b8; border: 1px dashed rgba(148, 163, 184, 0.2); } /* Cinza */
        
        /* Anivers√°rio */
        .bg-birthday { 
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), rgba(168, 85, 247, 0.15)); 
            color: #f472b6; 
            border: 1px solid rgba(236, 72, 153, 0.3);
            display: flex; justify-content: center; align-items: center; gap: 2px;
        }

        .input-dark {
            background-color: #0f172a;
            border: 1px solid #334155;
            color: white;
            border-radius: 0.5rem;
            padding: 0.5rem;
            width: 100%;
            font-size: 0.875rem;
        }
        .input-dark:focus { outline: none; border-color: #6366f1; ring: 1px #6366f1; }

        /* Anima√ß√£o simples */
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Ajuste da Coluna Fixa para mesclar com o fundo */
        th.sticky-col, td.sticky-col {
            position: sticky;
            left: 0;
            z-index: 20; /* Maior Z-index para a foto ficar acima */
            background-color: #1e293b;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
        }
        tr:hover td.sticky-col { background-color: #334155; }
        
        /* Imagem de Perfil */
        .profile-pic {
            object-fit: cover;
            width: 100%;
            height: 100%;
        }
    
        /* ===========================
           RESPONSIVIDADE (MOBILE)
           - No mobile, esconder colunas de meses (Jan..Dez)
           - Opcional: esconder coluna Editar no mobile
           =========================== */
        @media (max-width: 640px) {
            .month-col { display: none !important; }
            .extra-col { display: none !important; }
            #editColHead, td.edit-col { display: none !important; }
            th.sticky-col, td.sticky-col { min-width: 170px; }
        

            /* Tight layout para caber tudo na tela */
            .px-6 { padding-left: 0.75rem !important; padding-right: 0.75rem !important; }
            .mt-6 { margin-top: 0.75rem !important; }
            .gap-6 { gap: 0.75rem !important; }
            .pb-14 { padding-bottom: 2rem !important; }

            .card { padding: 0.9rem !important; border-radius: 0.9rem !important; }
            .card h2.text-2xl { font-size: 1.25rem !important; }

            #searchInput { width: 140px !important; }

            /* Tabela compacta (sem scroll lateral) */
            .table-compact { table-layout: fixed !important; }
            .table-compact th, .table-compact td { padding: 0.45rem 0.35rem !important; line-height: 1.15 !important; }
            .table-compact th { font-size: 0.60rem !important; }
            .table-compact td { font-size: 0.78rem !important; }

            th.sticky-col, td.sticky-col { min-width: 145px !important; }
            th.sticky-col { padding-left: 0.65rem !important; }

            .col-multa { width: 56px !important; min-width: 56px !important; }
            .col-total { width: 78px !important; min-width: 78px !important; }
            .col-falta { width: 78px !important; min-width: 78px !important; }

            .avatar { width: 1.75rem !important; height: 1.75rem !important; }
}

        /* Cards mais minimalistas e arredondados */
        .mini-pill { border-radius: 9999px !important; }
        @media (max-width: 640px) {
            .mini-pill { padding: 10px 12px !important; }
        }

/* ====== Santa runner (progresso) ====== */
.santa-track { position: relative; }
.santa-runner {
  position: absolute;
  top: 50%;
  left: 0%;
  transform: translate(-50%, -65%);
  width: 42px;
  height: 42px;
  pointer-events: none;
  transition: left 1000ms ease;
  filter: drop-shadow(0 6px 10px rgba(0,0,0,.35));
  animation: santaBob 900ms ease-in-out infinite;
}
.santa-destination {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-55%);
  width: 34px;
  height: 34px;
  pointer-events: none;
  opacity: .9;
  filter: drop-shadow(0 6px 10px rgba(0,0,0,.25));
}
@keyframes santaBob {
  0%,100% { transform: translate(-50%, -65%) translateY(0); }
  50% { transform: translate(-50%, -65%) translateY(-2px); }
}

/* ====== Gift fill (status de quita√ß√£o) ====== */
.gift-wrap { width: 190px; height: 190px; }
.gift-svg { width: 100%; height: 100%; }

.gift-wave-1 { animation: waveMove 3.5s linear infinite; opacity: .95; }
.gift-wave-2 { animation: waveMove 5.5s linear infinite reverse; opacity: .55; }

@keyframes waveMove {
  from { transform: translateX(0); }
  to   { transform: translateX(-48px); }
}

/* SVG transform compatibility */
.gift-wave-1, .gift-wave-2 {
  transform-box: fill-box;
  transform-origin: center;
}

/* Mobile: reduz */
@media (max-width: 640px) {
  .santa-runner { width: 34px; height: 34px; transform: translate(-50%, -70%); }
  .santa-destination { width: 28px; height: 28px; }
  .gift-wrap { width: 160px; height: 160px; }
}

</style>
</head>
<body class="flex flex-col min-h-screen">
    <!-- Login Overlay (controle simples: N√ÉO √© seguran√ßa real) -->
    <div id="loginOverlay" class="fixed inset-0 z-[200] flex items-center justify-center p-6">
        <!-- Fundo -->
        <div class="absolute inset-0 login-bg"></div>

        <!-- Card -->
        <div class="relative w-full max-w-xl rounded-2xl overflow-hidden border border-white/10 bg-slate-900/40 backdrop-blur-xl shadow-2xl">
            <div class="h-1 w-full login-topline"></div>

            <div class="p-10 sm:p-12">
                <div class="mx-auto w-16 h-16 rounded-2xl bg-white/5 flex items-center justify-center ring-1 ring-white/10 shadow">
                    <span class="text-3xl">üéÖ</span>
                </div>

                <h1 class="mt-6 text-center text-3xl sm:text-4xl font-extrabold text-white tracking-tight">
                    Natal Fam√≠lia <span class="text-indigo-300">2026</span>
                </h1>
                <p class="mt-2 text-center text-sm text-slate-300">Gest√£o Financeira &amp; Metas</p>

                <div class="mt-8 space-y-5">
                    <div>
                        <label class="block text-xs font-semibold tracking-wider text-slate-300">USU√ÅRIO</label>
                        <input id="loginUser" class="mt-2 w-full rounded-lg bg-slate-900/40 border border-white/10 px-4 py-3 text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/60 focus:border-indigo-400/40"
                               placeholder="Ex: admin" autocomplete="username" />
                    </div>

                    <div>
                        <label class="block text-xs font-semibold tracking-wider text-slate-300">SENHA</label>
                        <input id="loginPass" type="password" class="mt-2 w-full rounded-lg bg-slate-900/40 border border-white/10 px-4 py-3 text-slate-100 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/60 focus:border-indigo-400/40"
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
                    </div>

                    <p id="loginError" class="text-xs text-rose-300 hidden"></p>

                    <button id="loginBtn" onclick="doLogin()" class="w-full rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white py-3 font-semibold tracking-wide shadow-lg shadow-indigo-600/20 transition">
                        ENTRAR
                    </button>
                </div>
            </div>

            <div class="border-t border-white/10 px-10 py-4 text-center text-xs text-slate-400">
                Natal Fam√≠lia 2026
            </div>
        </div>
    </div>

<!-- Navbar -->
    <nav class="bg-slate-800 border-b border-slate-700 sticky top-0 z-50 h-16 shadow-md">
        <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-1.5 rounded-lg shadow-lg">
                    <i class="ph ph-gift text-xl text-white"></i>
                </div>
                <h1 class="text-lg font-bold text-white tracking-tight hidden sm:block">Natal Fam√≠lia <span class="text-indigo-400">2026</span></h1>
            </div>
            
            <div class="flex bg-slate-900/50 p-1 rounded-lg border border-slate-700">
                <button onclick="switchTab('dashboard')" id="btn-dashboard" class="tab-btn active">
                    <i class="ph ph-chart-pie-slice mr-1"></i> Painel
                </button>
                <button onclick="switchTab('admin')" id="btn-admin" class="tab-btn">
                    <i class="ph ph-gear mr-1"></i> Configurar
                </button>
            </div>

            <button onclick="logout()" class="text-xs text-slate-300 hover:text-white font-medium px-3 py-2 rounded border border-slate-700 hover:bg-slate-700/40 transition">
                <i class="ph ph-sign-out mr-1"></i> Sair
            </button>
        </div>
    </nav>

    <!-- Conte√∫do -->
    <main class="flex-grow p-4 sm:p-6 w-full max-w-7xl mx-auto space-y-6">

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="fade-in space-y-6">
            
            <!-- Header A√ß√µes -->
            <div class="flex flex-col sm:flex-row justify-between items-end sm:items-center gap-4">
                <div>
                    <h2 class="text-xl font-bold text-white">Vis√£o Geral Financeira</h2>
                    <p class="text-sm text-slate-400">Acompanhamento de pagamentos e metas.</p>
                </div>
                <div class="flex gap-3">
                    <button id="btn-reset" onclick="resetData()" class="text-xs text-rose-400 hover:text-rose-300 font-medium px-3 py-2 border border-rose-900 rounded hover:bg-rose-900/20 transition flex items-center gap-2">
                        <i class="ph ph-trash"></i> Resetar
                    </button>
                    <label id="lbl-import" class="cursor-pointer bg-slate-800 hover:bg-slate-700 border border-slate-600 text-slate-300 px-4 py-2 rounded text-xs font-bold uppercase transition flex items-center gap-2">
                        <i class="ph ph-file-csv text-green-400 text-lg"></i> Importar CSV
                        <input type="file" id="csvInput" accept=".csv" class="hidden">
                    </label>
                    <button id="exportCsvBtn" type="button" class="px-3 py-2 rounded-md bg-slate-700 hover:bg-slate-600 text-slate-100 text-xs font-bold uppercase transition flex items-center gap-2">
                                                <i class="ph ph-download-simple text-emerald-400 text-lg"></i> Exportar CSV
                                            </button>

                </div>
            </div>

            <!-- Cards Resumo -->
            <div id="dashboardSummary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- JS Preenche -->
            </div>

            <!-- Tabela Detalhada (AGORA COM FOTOS E ANIVERS√ÅRIOS) -->
            <div class="card overflow-hidden !p-0 border border-slate-700">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800">
                    <h3 class="text-sm font-bold text-white flex items-center gap-2">
                        <i class="ph ph-users text-indigo-400"></i> Detalhamento por Participante
                    </h3>
                    <div class="flex items-center gap-2">
                        <input type="text" id="searchInput" placeholder="Buscar participante..." class="input-dark !w-48 !py-1 !text-xs">
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse table-compact">
                        <thead>
                            <tr class="bg-slate-900 text-slate-400 text-[10px] uppercase font-bold border-b border-slate-700">
                                <th class="p-3 sticky-col min-w-[170px] text-slate-300 pl-4">Participante</th>
                                <th class="p-2 text-center w-14 month-col">Jan</th>
                                <th class="p-2 text-center w-14 month-col">Fev</th>
                                <th class="p-2 text-center w-14 month-col">Mar</th>
                                <th class="p-2 text-center w-14 month-col">Abr</th>
                                <th class="p-2 text-center w-14 month-col">Mai</th>
                                <th class="p-2 text-center w-14 month-col">Jun</th>
                                <th class="p-2 text-center w-14 month-col">Jul</th>
                                <th class="p-2 text-center w-14 month-col">Ago</th>
                                <th class="p-2 text-center w-14 month-col">Set</th>
                                <th class="p-2 text-center w-14 month-col">Out</th>
                                <th class="p-2 text-center w-14 month-col">Nov</th>
                                <th class="p-2 text-center w-14 month-col">Dez</th>
                                <!-- Coluna Multa (D√≠vida) -->
                                <th class="p-2 text-center bg-rose-900/10 border-l border-rose-900/20 text-rose-400 min-w-[60px] col-multa" title="D√≠vida de Multa">Multa</th>
                                <!-- Coluna Extra (Pagamento) -->
                                <th class="p-2 text-center bg-indigo-900/10 border-l border-indigo-900/20 text-indigo-400 min-w-[60px] extra-col extra-col" title="Valor Extra Pago">Extra</th>
                                <th class="p-2 text-right bg-slate-800/50 min-w-[90px] col-total col-total">Total Pago</th>
                                <th class="p-2 text-right bg-slate-800/50 border-r border-slate-700 min-w-[90px] col-falta col-falta">Falta</th>
                                <th id="editColHead" class="p-2 text-center sticky right-0 bg-slate-900 z-10 w-16 shadow-[-5px_0_10px_rgba(0,0,0,0.2)]">Editar</th>
                            </tr>
                        </thead>
                        <tbody id="participantsTableBody" class="text-sm divide-y divide-slate-700 bg-slate-800">
                            <!-- JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Gr√°ficos -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Gr√°fico Status -->
                <div class="card lg:col-span-1 flex flex-col items-center justify-center">
                    <h3 class="text-sm font-bold text-slate-400 w-full mb-4 flex items-center gap-2 border-b border-slate-700 pb-2">
                        <i class="ph ph-chart-donut text-indigo-400"></i> Status de Quita√ß√£o
                    </h3>
                    <div class="gift-wrap relative my-4">
    <svg class="gift-svg" viewBox="0 0 160 160">
        <defs>
            <linearGradient id="giftFillGrad" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="rgba(16,185,129,.95)"/>
                <stop offset="100%" stop-color="rgba(20,184,166,.85)"/>
            </linearGradient>

            <clipPath id="giftClip">
                <rect x="46" y="74" width="68" height="58" rx="10"></rect>
            </clipPath>
        </defs>

        <!-- FILL (clipped) -->
        <g clip-path="url(#giftClip)">
            <g id="giftFillLevel" transform="translate(0,58)">
                <rect x="46" y="74" width="68" height="90" fill="url(#giftFillGrad)"></rect>

                <g>
                    <path class="gift-wave-1" fill="rgba(255,255,255,.22)"
                          d="M30 92
                             C 44 84, 58 100, 72 92
                             C 86 84, 100 100, 114 92
                             C 128 84, 142 100, 156 92
                             L 156 160 L 30 160 Z"/>
                    <path class="gift-wave-2" fill="rgba(255,255,255,.16)"
                          d="M30 98
                             C 46 90, 62 106, 78 98
                             C 94 90, 110 106, 126 98
                             C 142 90, 158 106, 174 98
                             L 174 160 L 30 160 Z"/>
                </g>
            </g>
        </g>

        <!-- OUTLINE -->
        <rect x="40" y="68" width="80" height="72" rx="14"
              fill="rgba(30,41,59,.55)" stroke="rgba(148,163,184,.25)" stroke-width="2"/>
        <rect x="36" y="52" width="88" height="22" rx="12"
              fill="rgba(30,41,59,.65)" stroke="rgba(148,163,184,.25)" stroke-width="2"/>

        <rect x="76" y="52" width="8" height="88" rx="4" fill="rgba(99,102,241,.85)"/>
        <rect x="36" y="60" width="88" height="8" rx="4" fill="rgba(99,102,241,.85)"/>

        <path d="M80 52
                 C 68 40, 52 44, 56 58
                 C 60 70, 74 66, 80 58
                 C 86 66, 100 70, 104 58
                 C 108 44, 92 40, 80 52 Z"
              fill="rgba(99,102,241,.95)"/>
    </svg>

    <div class="absolute inset-0 flex flex-col items-center justify-center">
        <span id="pieChartPercent" class="text-3xl font-bold text-white">0%</span>
        <span class="text-xs text-slate-500 uppercase tracking-widest font-bold">Pago</span>
    </div>
</div>

<div class="grid grid-cols-2 gap-4 w-full mt-2">
                        <div class="bg-slate-900 p-2 rounded text-center border border-slate-700" mini-pill">
                            <span id="countOk" class="block text-lg font-bold text-emerald-400">0</span>
                            <span class="text-[10px] uppercase text-slate-500 font-bold">Em dia</span>
                        </div>
                        <div class="bg-slate-900 p-2 rounded text-center border border-slate-700" mini-pill">
                            <span id="countPending" class="block text-lg font-bold text-rose-400">0</span>
                            <span class="text-[10px] uppercase text-slate-500 font-bold">Pendente</span>
                        </div>
                    </div>
                </div>

                <!-- Barra Progresso -->
                <div class="card lg:col-span-2 flex flex-col justify-between">
                    <div>
                        <h3 class="text-sm font-bold text-slate-400 mb-6 flex items-center gap-2 border-b border-slate-700 pb-2">
                            <i class="ph ph-trend-up text-emerald-400"></i> Evolu√ß√£o da Arrecada√ß√£o
                        </h3>
                        <div class="flex justify-between text-sm text-slate-300 mb-2">
                            <span>Progresso Atual</span>
                            <span id="metaLabel" class="font-mono text-slate-400">Meta: R$ 0</span>
                        </div>
                        <div id="progressTrack" class="w-full bg-slate-900 rounded-full h-8 border border-slate-700 relative overflow-hidden santa-track">
    <div id="mainProgressBar" class="bg-gradient-to-r from-emerald-600 to-teal-500 h-full rounded-full text-right pr-3 flex items-center justify-end text-xs font-bold text-white shadow-[0_0_10px_rgba(16,185,129,0.3)] transition-all duration-1000" style="width: 0%">
        0%
    </div>

    <!-- Destino (√°rvore) -->
    <div class="santa-destination" aria-hidden="true">
        <svg viewBox="0 0 64 64" class="w-full h-full">
            <path d="M32 6 L14 34 H24 L10 54 H54 L40 34 H50 Z" fill="rgba(16,185,129,.85)"/>
            <rect x="28" y="48" width="8" height="10" rx="2" fill="rgba(148,163,184,.75)"/>
            <circle cx="44" cy="18" r="3" fill="rgba(250,204,21,.9)"/>
        </svg>
    </div>

    <!-- Noel correndo -->
    <div id="santaRunner" class="santa-runner" aria-hidden="true">
        <svg viewBox="0 0 64 64" class="w-full h-full">
            <path d="M22 18c7-10 20-10 28 0l-4 6H26z" fill="white" opacity=".9"/>
            <path d="M24 18c6-8 16-8 22 0l-3 5H27z" fill="#ef4444"/>
            <circle cx="48" cy="21" r="4" fill="white"/>

            <circle cx="32" cy="30" r="10" fill="#fde68a"/>
            <path d="M24 34c4 7 12 7 16 0" fill="none" stroke="white" stroke-width="5" stroke-linecap="round"/>
            <circle cx="28" cy="29" r="1.5" fill="#0f172a"/>
            <circle cx="36" cy="29" r="1.5" fill="#0f172a"/>

            <path d="M18 46c6-10 22-10 28 0v8H18z" fill="#ef4444"/>
            <rect x="28" y="44" width="10" height="6" rx="2" fill="#0f172a" opacity=".85"/>

            <path d="M24 54l-8 6" stroke="#0f172a" stroke-width="5" stroke-linecap="round"/>
            <path d="M40 54l10 4" stroke="#0f172a" stroke-width="5" stroke-linecap="round"/>
        </svg>
    </div>
</div>
                    </div>
                    <div class="grid grid-cols-3 gap-4 mt-8">
                        <div class="bg-slate-900 p-4 rounded-lg border border-slate-700 text-center" mini-pill">
                            <p class="text-[10px] text-slate-500 font-bold uppercase mb-1">Esperado Total</p>
                            <p id="summaryTotalExpected" class="text-lg font-bold text-white">R$ 0</p>
                        </div>
                        <div class="bg-slate-900 p-4 rounded-lg border border-slate-700 text-center" mini-pill">
                            <p class="text-[10px] text-slate-500 font-bold uppercase mb-1">Confirmado</p>
                            <p id="summaryTotalPaid" class="text-lg font-bold text-emerald-400">R$ 0</p>
                        </div>
                        <div class="bg-slate-900 p-4 rounded-lg border border-slate-700 text-center" mini-pill">
                            <p class="text-[10px] text-slate-500 font-bold uppercase mb-1">Em Aberto</p>
                            <p id="summaryTotalMissing" class="text-lg font-bold text-rose-400">R$ 0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: ADMIN -->
        <div id="view-admin" class="hidden fade-in max-w-5xl mx-auto space-y-8">
            <h2 class="text-2xl font-bold text-white">Configura√ß√µes do Sistema</h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <!-- 1. Metas Mensais -->
                <div class="card border-l-4 border-l-indigo-500">
                    <h3 class="text-base font-bold text-white mb-2 flex items-center gap-2">
                        <i class="ph ph-currency-dollar text-indigo-400"></i> Metas Mensais (R$)
                    </h3>
                    <p class="text-xs text-slate-400 mb-6">Defina quanto cada pessoa deve pagar por m√™s.</p>

                    <div class="grid grid-cols-3 sm:grid-cols-4 gap-3" id="monthlyGoalsContainer">
                        <!-- JS Inputs -->
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-slate-700 flex justify-between items-center">
                        <div class="text-xs text-slate-400">Total Anual por Pessoa: <span id="totalAnnualGoal" class="text-white font-mono font-bold ml-1">R$ 0,00</span></div>
                        <button onclick="saveMonthlyGoals()" class="bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold uppercase py-2 px-4 rounded transition shadow-lg">Salvar Metas</button>
                    </div>
                </div>

                <!-- Coluna Direita -->
                <div class="space-y-6">
                    
                    <!-- 2. Cadastro R√°pido -->
                    <div class="card border-l-4 border-l-emerald-500">
                        <h3 class="text-base font-bold text-white mb-4 flex items-center gap-2">
                            <i class="ph ph-user-plus text-emerald-400"></i> Novo Participante
                        </h3>
                        
                        <div class="space-y-3">
                            <input type="text" id="newUserName" placeholder="Nome Completo" class="input-dark">
                            <div class="flex gap-2 items-center">
                                <!-- Bot√£o de Upload de Foto -->
                                <label class="cursor-pointer bg-slate-700 hover:bg-slate-600 text-white p-2 rounded text-xs flex items-center justify-center min-w-[40px] border border-slate-600 transition" title="Escolher Foto">
                                    <i class="ph ph-camera text-lg"></i>
                                    <input type="file" id="newUserPhotoFile" accept="image/*" class="hidden" onchange="previewAddUserImage(this)">
                                </label>
                                <span id="newUserPhotoName" class="text-xs text-slate-500 truncate max-w-[100px] hidden">Foto selecionada</span>

                                <select id="newUserBirthday" class="input-dark text-xs flex-grow">
                                    <option value="">M√™s do Anivers√°rio</option>
                                    <option value="0">Janeiro</option><option value="1">Fevereiro</option><option value="2">Mar√ßo</option>
                                    <option value="3">Abril</option><option value="4">Maio</option><option value="5">Junho</option>
                                    <option value="6">Julho</option><option value="7">Agosto</option><option value="8">Setembro</option>
                                    <option value="9">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option>
                                </select>
                            </div>
                            <button onclick="addParticipant()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-2 rounded font-bold transition">Adicionar</button>
                        </div>
                        
                        <!-- Mini Lista -->
                        <div class="mt-6 border-t border-slate-700 pt-4">
                            <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Cadastrados</h4>
                            <div class="overflow-y-auto max-h-40 rounded border border-slate-700">
                                <table class="w-full text-left">
                                    <tbody id="adminUsersTableBody" class="divide-y divide-slate-700 text-xs text-slate-300 bg-slate-900"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Multas -->
                    <div class="card border-l-4 border-l-rose-500">
                        <h3 class="text-base font-bold text-white mb-2 flex items-center gap-2">
                            <i class="ph ph-siren text-rose-400"></i> Auditoria de Inadimpl√™ncia
                        </h3>
                        <p class="text-[10px] text-slate-400 mb-4 bg-slate-900 p-2 rounded border border-slate-700">
                            <strong>Regra:</strong> Quem n√£o tiver pago o m√≠nimo at√© a data limite recebe uma <strong>Multa (D√≠vida)</strong>.
                        </p>

                        <div class="space-y-3">
                            <div>
                                <label class="text-[10px] text-slate-500 font-bold uppercase block mb-1">Data Limite (Prazo)</label>
                                <input type="text" id="fineDeadline" class="input-dark bg-slate-900" placeholder="Ex: 20/05/2026" onchange="saveFineConfig()">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] text-slate-500 font-bold uppercase block mb-1">M√≠nimo Pago (R$)</label>
                                    <input type="number" id="fineThreshold" class="input-dark" value="50" onchange="saveFineConfig()">
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-500 font-bold uppercase block mb-1">Multa (R$)</label>
                                    <input type="number" id="fineValue" class="input-dark border-rose-500/30 text-rose-400" value="15" onchange="saveFineConfig()">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 pt-3 border-t border-slate-700">
                            <button onclick="manualFineCheck()" class="w-full bg-rose-900/30 border border-rose-500/30 hover:bg-rose-900/50 text-rose-200 text-xs font-bold uppercase py-2 rounded transition flex items-center justify-center gap-2">
                                <i class="ph ph-gavel"></i> Verificar e Aplicar
                            </button>
                            <p id="fineFeedback" class="text-center text-xs mt-2 text-slate-500 h-4"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal Editar -->
    <div id="editPaymentModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center px-4 bg-slate-900/80 backdrop-blur-sm fade-in">
        <div class="bg-slate-800 rounded-lg shadow-2xl border border-slate-600 w-full max-w-xl overflow-hidden">
            <div class="bg-slate-900 px-6 py-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="text-lg font-bold text-white flex items-center gap-2"><i class="ph ph-pencil-simple text-indigo-400"></i> Editar Dados</h3>
                <button onclick="closeEditModal()" class="text-slate-400 hover:text-white transition"><i class="ph ph-x text-xl"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto max-h-[80vh]">
                <!-- Info do Usu√°rio -->
                <div class="mb-6 pb-4 border-b border-slate-700">
                    <h4 class="text-xs font-bold uppercase text-slate-500 mb-3">Informa√ß√µes Pessoais</h4>
                    <div class="flex gap-4 items-start">
                        <!-- Foto Clic√°vel para Editar -->
                        <div class="relative w-16 h-16 rounded-full bg-slate-700 flex-shrink-0 border-2 border-slate-600 overflow-hidden cursor-pointer group" onclick="document.getElementById('editPhotoFile').click()">
                            <img id="modalAvatarImg" class="profile-pic hidden" src="" alt="">
                            <div id="modalAvatarText" class="absolute inset-0 flex items-center justify-center text-2xl font-bold text-slate-400">A</div>
                            <!-- Overlay de Edi√ß√£o -->
                            <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center text-white text-xs">
                                <i class="ph ph-camera"></i>
                            </div>
                            <input type="file" id="editPhotoFile" accept="image/*" class="hidden" onchange="previewEditUserImage(this)">
                        </div>

                        <div class="space-y-3 flex-grow">
                            <div>
                                <label class="text-[10px] text-slate-400 uppercase font-bold">M√™s do Anivers√°rio</label>
                                <select id="editBirthdayMonth" class="input-dark text-xs p-1.5">
                                    <option value="-1">Sem registro</option>
                                    <option value="0">Janeiro</option><option value="1">Fevereiro</option><option value="2">Mar√ßo</option>
                                    <option value="3">Abril</option><option value="4">Maio</option><option value="5">Junho</option>
                                    <option value="6">Julho</option><option value="7">Agosto</option><option value="8">Setembro</option>
                                    <option value="9">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <h2 class="text-xl font-bold text-white mt-4" id="modalParticipantName">Nome</h2>
                </div>
                
                <input type="hidden" id="editParticipantIndex">

                <h4 class="text-xs font-bold uppercase text-slate-500 mb-3">Pagamentos Mensais</h4>
                <div class="grid grid-cols-3 sm:grid-cols-4 gap-3 mb-6" id="editMonthsContainer">
                    <!-- JS Inputs -->
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- Campo MULTA (D√çVIDA) -->
                    <div class="bg-rose-900/10 p-3 rounded border border-rose-500/20">
                        <label class="text-xs font-bold uppercase text-rose-400 block mb-2">Multa (D√≠vida)</label>
                        <div class="flex items-center gap-2">
                            <span class="text-slate-500 text-sm">R$</span>
                            <input type="number" id="editFineValue" class="bg-slate-900 border border-rose-500/30 text-rose-400 font-bold rounded w-full p-1 text-right focus:border-rose-500 outline-none">
                        </div>
                    </div>

                    <!-- Campo EXTRA (PAGAMENTO) -->
                    <div class="bg-indigo-900/10 p-3 rounded border border-indigo-500/20">
                        <label class="text-xs font-bold uppercase text-indigo-400 block mb-2">Extra Pago (Cr√©dito)</label>
                        <div class="flex items-center gap-2">
                            <span class="text-slate-500 text-sm">R$</span>
                            <input type="number" id="editExtraValue" class="bg-slate-900 border border-indigo-500/30 text-indigo-400 font-bold rounded w-full p-1 text-right focus:border-indigo-500 outline-none">
                        </div>
                    </div>
                </div>
                
                <div id="fineWarning" class="hidden mt-4 p-2 bg-rose-900/30 border border-rose-500/30 rounded text-xs text-rose-300 text-center animate-pulse">
                    ‚ö†Ô∏è Aten√ß√£o: Pagamento em atraso. Uma multa de R$ <span id="fineWarnValue"></span> ser√° lan√ßada como d√≠vida.
                </div>
            </div>

            <div class="bg-slate-900 px-6 py-4 flex justify-end gap-3 border-t border-slate-700">
                <button onclick="closeEditModal()" class="px-4 py-2 rounded text-sm font-bold text-slate-400 hover:text-white hover:bg-slate-800 transition">Cancelar</button>
                <button onclick="saveEditModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded text-sm font-bold shadow-lg transition">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <!-- JS Logic -->
    <script>
        const MONTHS_FULL = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        const MONTH_ABBR = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
        
        // Dados de 2026
        const DEFAULT_MONTHLY_GOALS = [0, 0, 30, 30, 30, 30, 30, 30, 30, 30, 55, 55];
        let monthlyGoals = [...DEFAULT_MONTHLY_GOALS];
        let participantsData = [];
        const DEFAULT_FINE_CONFIG = { deadline: '20/05/2026', threshold: 50, value: 15 };
        let fineConfig = { ...DEFAULT_FINE_CONFIG };
        
        // Vari√°veis tempor√°rias
        let tempAddPhotoBase64 = '';
        let tempEditPhotoBase64 = '';

        // --- SUPABASE (Caminho A: direto do front) ---
        // Preencha com os dados do seu projeto (Settings > API no Supabase)
        const SUPABASE_URL = "https://nctjowqubtfbejipxhhd.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5jdGpvd3F1YnRmYmVqaXB4aGhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczODk1NjYsImV4cCI6MjA4Mjk2NTU2Nn0.63GaaShzKx0oO6n4ci0Rj3onmenYycjcE0EN7vVvErE";
        const SUPABASE_TABLE = "app_state"; // tabela criada no Supabase
        const SUPABASE_KEYS = { participants: "participants", goals: "goals", fine: "fine" };

        // Client (usa o anon key no navegador)
        const sb = (window.supabase && SUPABASE_URL.includes("supabase.co") && SUPABASE_ANON_KEY.startsWith("ey"))
          ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
          : null;

        function warnSupabaseNotConfigured() {
            console.warn("[Supabase] N√£o configurado. Preencha SUPABASE_URL e SUPABASE_ANON_KEY no c√≥digo.");
        }


        
        // --- LOGIN SIMPLES (hardcoded) ---
        // IMPORTANTE: isso N√ÉO √© seguran√ßa real (qualquer pessoa pode inspecionar o c√≥digo).
        // Serve apenas como controle de interface.
        const AUTH_USERS = {
            admin: { password: 'Admin2026', role: 'admin' },
            natal: { password: '2026', role: 'viewer' }
        };

        let currentRole = null; // 'admin' | 'viewer'
        let isAdmin = false;

        function setRole(role) {
            currentRole = role;
            isAdmin = (role === 'admin');
            applyRoleUI();
        }

        function applyRoleUI() {
            const btnAdmin = document.getElementById('btn-admin');
            const viewAdmin = document.getElementById('view-admin');

            if (!isAdmin) {
                btnAdmin?.classList.add('hidden');
                // garante que n√£o vai ficar preso na aba admin
                if (!viewAdmin?.classList.contains('hidden')) switchTab('dashboard');

                // esconde a√ß√µes perigosas no painel
                document.getElementById('btn-reset')?.classList.add('hidden');
                document.getElementById('lbl-import')?.classList.add('hidden');
                document.getElementById('exportCsvBtn')?.classList.add('hidden');
                document.getElementById('editColHead')?.classList.add('hidden');
            } else {
                btnAdmin?.classList.remove('hidden');
                document.getElementById('btn-reset')?.classList.remove('hidden');
                document.getElementById('lbl-import')?.classList.remove('hidden');
                document.getElementById('exportCsvBtn')?.classList.remove('hidden');
                document.getElementById('editColHead')?.classList.remove('hidden');
            }
        }

        function requireAdmin() {
            if (isAdmin) return true;
            alert("Acesso restrito: somente Admin pode editar.");
            return false;
        }

        function initAuth() {
            // Por padr√£o, bloqueia tudo at√© logar
            applyRoleUI();

            const sessionRaw = localStorage.getItem('natal2026_session');
            if (sessionRaw) {
                try {
                    const sess = JSON.parse(sessionRaw);
                    if (sess && (sess.role === 'admin' || sess.role === 'viewer')) {
                        setRole(sess.role);
                        document.getElementById('loginOverlay')?.classList.add('hidden');
                        return;
                    }
                } catch (e) {}
            }

            // sem sess√£o -> mostra overlay
            document.getElementById('loginOverlay')?.classList.remove('hidden');

            // Enter para logar
            const userEl = document.getElementById('loginUser');
            const passEl = document.getElementById('loginPass');
            [userEl, passEl].forEach(el => {
                el?.addEventListener('keydown', (ev) => {
                    if (ev.key === 'Enter') doLogin();
                });
            });
        }

        function doLogin() {
            const user = (document.getElementById('loginUser')?.value || '').trim().toLowerCase();
            const pass = (document.getElementById('loginPass')?.value || '').trim();

            const err = document.getElementById('loginError');
            err?.classList.add('hidden');
            if (err) err.innerText = '';

            const rec = AUTH_USERS[user];
            if (!rec || rec.password !== pass) {
                if (err) {
                    err.innerText = 'Usu√°rio ou senha inv√°lidos.';
                    err.classList.remove('hidden');
                }
                return;
            }

            setRole(rec.role);
            localStorage.setItem('natal2026_session', JSON.stringify({ role: rec.role, user }));
            document.getElementById('loginOverlay')?.classList.add('hidden');

            // garante a renderiza√ß√£o correta ap√≥s login
            calculateTotalsAndRender();
        }

        function logout() {
            localStorage.removeItem('natal2026_session');
            setRole(null);
            isAdmin = false;
            document.getElementById('loginOverlay')?.classList.remove('hidden');
        }
// --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            
            initAuth();
            await loadFromLocal();
            initDatePickers();
            renderMonthlyGoalsInputs();
            updateTotalAnnualGoalUI();
            
            // Carrega config de multa
            document.getElementById('fineThreshold').value = fineConfig.threshold;
            document.getElementById('fineValue').value = fineConfig.value;
            
            // Roda verifica√ß√£o autom√°tica de multas ao iniciar
            setTimeout(checkAndApplyFinesAutomatic, 500); 
        });

        // --- STORAGE (ATUALIZADO PARA 2026) ---
        function saveToLocal() {
            // Agora salva no Supabase (Caminho A)
            if (!sb) { warnSupabaseNotConfigured(); return; }

            const rows = [
                { key: SUPABASE_KEYS.participants, value: participantsData, updated_at: new Date().toISOString() },
                { key: SUPABASE_KEYS.goals,        value: monthlyGoals,     updated_at: new Date().toISOString() },
                { key: SUPABASE_KEYS.fine,         value: fineConfig,       updated_at: new Date().toISOString() }
            ];

            sb.from(SUPABASE_TABLE)
              .upsert(rows, { onConflict: "key" })
              .then(({ error }) => {
                  if (error) {
                      console.error("[Supabase] Erro ao salvar:", error);
                      alert("Erro ao salvar no Supabase. Veja o console (F12).");
                  }
              })
              .catch((e) => {
                  console.error("[Supabase] Erro ao salvar:", e);
                  alert("Erro ao salvar no Supabase. Veja o console (F12).");
              });
        }

        async function loadFromLocal() {
            // Agora carrega do Supabase (Caminho A)
            if (!sb) {
                warnSupabaseNotConfigured();
                loadDemoData();
                calculateTotalsAndRender();
                return;
            }

            try {
                const { data, error } = await sb
                    .from(SUPABASE_TABLE)
                    .select("key,value")
                    .in("key", [SUPABASE_KEYS.participants, SUPABASE_KEYS.goals, SUPABASE_KEYS.fine]);

                if (error) throw error;

                const map = {};
                (data || []).forEach(row => { map[row.key] = row.value; });

                // goals
                const loadedGoals = map[SUPABASE_KEYS.goals];
                if (Array.isArray(loadedGoals) && loadedGoals.length === 12) {
                    monthlyGoals = loadedGoals;
                } else {
                    monthlyGoals = [...DEFAULT_MONTHLY_GOALS];
                }

                // fine
                const loadedFine = map[SUPABASE_KEYS.fine];
                if (loadedFine && typeof loadedFine === 'object' && !Array.isArray(loadedFine)) {
                    fineConfig = {
                        deadline: loadedFine.deadline ?? DEFAULT_FINE_CONFIG.deadline,
                        threshold: Number.isFinite(+loadedFine.threshold) ? +loadedFine.threshold : DEFAULT_FINE_CONFIG.threshold,
                        value: Number.isFinite(+loadedFine.value) ? +loadedFine.value : DEFAULT_FINE_CONFIG.value,
                    };
                } else {
                    fineConfig = { ...DEFAULT_FINE_CONFIG };
                }

                if (map[SUPABASE_KEYS.participants] != null && Array.isArray(map[SUPABASE_KEYS.participants])) {
                    participantsData = map[SUPABASE_KEYS.participants];
                } else {
                    loadDemoData();
                }

                calculateTotalsAndRender();
            } catch (e) {
                console.error("[Supabase] Erro ao carregar:", e);
                alert("Erro ao carregar do Supabase. Vou abrir com dados de demonstra√ß√£o (veja o console).");
                loadDemoData();
                calculateTotalsAndRender();
            }
        }

        function saveFineConfig() {
            fineConfig.deadline = document.getElementById('fineDeadline').value;
            fineConfig.threshold = parseFloat(document.getElementById('fineThreshold').value);
            fineConfig.value = parseFloat(document.getElementById('fineValue').value);
            saveToLocal();
        }

        async function resetData() {
            if(!requireAdmin()) return;
            if(confirm("Deseja apagar todos os dados e come√ßar do zero?")) {
                // Zera no Supabase (mant√©m a sess√£o de login)
                participantsData = [];
                monthlyGoals = [...DEFAULT_MONTHLY_GOALS];
                fineConfig = { ...DEFAULT_FINE_CONFIG };

                // remove qualquer res√≠duo antigo do localStorage (opcional)
                localStorage.removeItem('natal2026_data');
                localStorage.removeItem('natal2026_goals');
                localStorage.removeItem('natal2026_fine');

                if (!sb) { warnSupabaseNotConfigured(); location.reload(); return; }

                try {
                    const rows = [
                        { key: SUPABASE_KEYS.participants, value: participantsData, updated_at: new Date().toISOString() },
                        { key: SUPABASE_KEYS.goals,        value: monthlyGoals,     updated_at: new Date().toISOString() },
                        { key: SUPABASE_KEYS.fine,         value: fineConfig,       updated_at: new Date().toISOString() }
                    ];
                    const { error } = await sb.from(SUPABASE_TABLE).upsert(rows, { onConflict: "key" });
                    if (error) throw error;
                } catch (e) {
                    console.error("[Supabase] Erro ao resetar:", e);
                    alert("Erro ao resetar no Supabase. Veja o console.");
                }

                location.reload();
            }
        }

        // --- UI ---
        function switchTab(tabName) {
            if(tabName === 'admin' && !isAdmin) { alert('Acesso restrito: somente Admin.'); return; }
const views = { dashboard: document.getElementById('view-dashboard'), admin: document.getElementById('view-admin') };
            const btns = { dashboard: document.getElementById('btn-dashboard'), admin: document.getElementById('btn-admin') };

            Object.values(views).forEach(el => el.classList.add('hidden'));
            Object.values(btns).forEach(el => el.classList.remove('active'));

            views[tabName].classList.remove('hidden');
            btns[tabName].classList.add('active');

            if(tabName === 'admin') renderAdminUserList();
        }

        function initDatePickers() {
            flatpickr("#fineDeadline", {
                dateFormat: "d/m/Y",
                locale: "pt",
                defaultDate: fineConfig.deadline || "20/05/2026",
                theme: "dark",
                onChange: function(selectedDates, dateStr, instance) {
                    fineConfig.deadline = dateStr;
                    saveToLocal();
                }
            });
        }

        // --- IMAGE HANDLING ---
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function previewAddUserImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const base64 = await readFileAsBase64(file);
                tempAddPhotoBase64 = base64;
                
                const label = document.getElementById('newUserPhotoName');
                label.innerText = file.name;
                label.classList.remove('hidden');
                
                input.parentElement.classList.remove('bg-slate-700');
                input.parentElement.classList.add('bg-emerald-600');
            }
        }

        async function previewEditUserImage(input) {
            if (input.files && input.files[0]) {
                const base64 = await readFileAsBase64(input.files[0]);
                tempEditPhotoBase64 = base64;
                
                const imgEl = document.getElementById('modalAvatarImg');
                const txtEl = document.getElementById('modalAvatarText');
                imgEl.src = base64;
                imgEl.classList.remove('hidden');
                txtEl.classList.add('hidden');
            }
        }

        // --- DATA ---
        function loadDemoData() {
            participantsData = [
                { id: 1, name: 'Adjane', months: [0,0,30,30,30,30,30,30,30,30,55,55], extra: 0, fine: 0, birthdayMonth: 8, photo: '' },
                { id: 2, name: 'Alexia', months: [0,0,30,30,30,30,30,30,30,30,55,55], extra: 0, fine: 0, birthdayMonth: null, photo: '' },
            ];
            calculateTotalsAndRender();
        }

        function calculateTotalsAndRender() {
            const baseTotalGoal = monthlyGoals.reduce((a,b) => a+b, 0);

            participantsData.forEach(p => {
                // Se fine n√£o existe (dados antigos), cria
                if (p.fine === undefined) p.fine = 0;

                let personalGoal = baseTotalGoal;
                let paidSum = 0;

                // Desconto Anivers√°rio
                if (p.birthdayMonth !== null && p.birthdayMonth >= 0 && p.birthdayMonth < 12) {
                    const birthdayDiscount = monthlyGoals[p.birthdayMonth];
                    personalGoal -= birthdayDiscount;
                }

                // Soma pagamentos
                p.months.forEach(val => paidSum += val);
                
                p.totalPaid = paidSum + (p.extra || 0);
                
                // Meta Total = Meta Base - Desconto + Multa
                p.totalGoal = personalGoal + (p.fine || 0);

                let missingCalc = p.totalGoal - p.totalPaid;
                p.missing = missingCalc < 0 ? 0 : missingCalc;
            });
            updateDashboard();
            saveToLocal();
        }

        function updateDashboard() {
            const totalArrecadado = participantsData.reduce((acc, p) => acc + p.totalPaid, 0);
            const totalFalta = participantsData.reduce((acc, p) => acc + p.missing, 0);
            const totalEsperado = totalArrecadado + totalFalta;
            const progress = totalEsperado > 0 ? (totalArrecadado / totalEsperado) * 100 : 0;
            const peopleOk = participantsData.filter(p => p.missing <= 0).length;
            
            // Cards Atualizados
            document.getElementById('dashboardSummary').innerHTML = `
                <div class="card border-l-4 border-l-emerald-500">
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Caixa Atual</p>
                    <h2 class="text-2xl font-bold text-white mt-1">R$ ${totalArrecadado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</h2>
                </div>
                <div class="card border-l-4 border-l-rose-500">
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Falta Receber</p>
                    <h2 class="text-2xl font-bold text-white mt-1">R$ ${totalFalta.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</h2>
                </div>
                <div class="card border-l-4 border-l-indigo-500">
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Participantes</p>
                    <div class="flex items-end gap-2 mt-1">
                        <h2 class="text-2xl font-bold text-white">${participantsData.length}</h2>
                        <span class="text-xs text-indigo-400 font-bold mb-1 px-2 rounded bg-indigo-900/30">${peopleOk} Quitados</span>
                    </div>
                </div>
                <div class="card border-l-4 border-l-amber-500">
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Extra Arrecadado</p>
                    <h2 class="text-2xl font-bold text-white mt-1">R$ ${participantsData.reduce((acc, p) => acc + (p.extra || 0), 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</h2>
                </div>
            `;

            document.getElementById('pieChartPercent').innerText = progress.toFixed(0) + '%';
            updateGiftProgress(progress);
            updateSantaRunner(progress);
document.getElementById('countOk').innerText = peopleOk;
            document.getElementById('countPending').innerText = participantsData.length - peopleOk;
            document.getElementById('mainProgressBar').style.width = `${progress}%`;
            document.getElementById('mainProgressBar').innerText = `${progress.toFixed(0)}%`;
            document.getElementById('metaLabel').innerText = `Meta: R$ ${totalEsperado.toLocaleString('pt-BR')}`;
            document.getElementById('summaryTotalExpected').innerText = `R$ ${totalEsperado.toLocaleString('pt-BR')}`;
            document.getElementById('summaryTotalPaid').innerText = `R$ ${totalArrecadado.toLocaleString('pt-BR')}`;
            document.getElementById('summaryTotalMissing').innerText = `R$ ${totalFalta.toLocaleString('pt-BR')}`;

            renderTable(participantsData);
        }

        function renderTable(data) {
            const tbody = document.getElementById('participantsTableBody');
            tbody.innerHTML = '';
            if (data.length === 0) { tbody.innerHTML = `<tr><td colspan="17" class="p-8 text-center text-slate-500">Nenhum participante cadastrado.</td></tr>`; return; }

            data.forEach((p, index) => {
                const realIndex = participantsData.findIndex(pp => pp.id === p.id);
                const clickAttr = isAdmin ? `onclick="openEditModal(${realIndex})"` : '';
                const editTd = isAdmin ? `
                    <td class="p-2 text-center align-middle sticky right-0 bg-slate-800 z-10 border-l border-slate-700 edit-col shadow-[-5px_0_10px_rgba(0,0,0,0.2)]">
                        <button onclick="openEditModal(${realIndex})" class="text-indigo-400 hover:text-white p-1.5 rounded hover:bg-indigo-600 transition shadow-sm"><i class="ph ph-pencil-simple text-lg"></i></button>
                    </td>
                ` : '';

                let monthsHTML = '';
                p.months.forEach((val, idx) => {
                    const goal = monthlyGoals[idx];
                    let badgeClass = 'bg-none'; 
                    let content = '';

                    if (p.birthdayMonth == idx) {
                        badgeClass = 'bg-birthday';
                        content = '<i class="ph ph-cake text-base"></i>';
                        if (val > 0) content += ` <span class="text-[9px]">${val}</span>`;
                    } else {
                        if (goal > 0) {
                            if (val >= goal) badgeClass = 'bg-paid';
                            else if (val > 0) badgeClass = 'bg-partial';
                            else badgeClass = 'bg-missed';
                        } else {
                            if (val > 0) badgeClass = 'bg-paid';
                            else badgeClass = 'bg-none';
                        }
                        content = val > 0 ? (Number.isInteger(val) ? val : val.toFixed(0)) : '-';
                    }
                    
                    monthsHTML += `<td class="p-2 text-center align-middle month-col"><span class="status-badge ${badgeClass}">${content}</span></td>`;
                });

                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-700 transition border-b border-slate-700 last:border-0 group';
                
                let avatarHTML;
                if (p.photo && p.photo.trim() !== "") {
                    avatarHTML = `<div class="avatar w-8 h-8 rounded-full overflow-hidden border-2 border-slate-600 flex-shrink-0 bg-slate-800"><img src="${p.photo}" class="profile-pic" onerror="this.style.display='none';this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center text-xs font-bold text-slate-400\\'>?</div>'"></div>`;
                } else {
                    avatarHTML = `<div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-[10px] text-slate-300 border border-slate-600 font-bold shadow-sm flex-shrink-0">${p.name.charAt(0)}</div>`;
                }

                // Visual da Multa (D√≠vida) e Extra (Pagamento)
                const fineVal = p.fine || 0;
                const extraVal = p.extra || 0;
                
                // Removido o sinal negativo
                const fineDisplay = fineVal > 0 ? `<span class="text-rose-400 font-bold" title="D√≠vida de Multa">R$${fineVal}</span>` : '-';
                const extraDisplay = extraVal > 0 ? `<span class="text-indigo-400 font-bold">+R$${extraVal}</span>` : '-';

                row.innerHTML = `
                    <td class="p-3 sticky-col z-20 font-medium text-white shadow-lg whitespace-nowrap cursor-pointer group-hover:text-indigo-400 transition-colors flex items-center gap-3" ${clickAttr}>
                        ${avatarHTML}
                        ${p.name}
                    </td>
                    ${monthsHTML}
                    <!-- Colunas trocadas para alinhar com o cabe√ßalho -->
                    <td class="p-2 text-center align-middle bg-rose-900/10 border-l border-rose-900/20 text-xs col-multa">${fineDisplay}</td>
                    <td class="p-2 text-center align-middle bg-indigo-900/10 border-l border-indigo-900/20 text-xs extra-col">${extraDisplay}</td>
                    <td class="p-2 text-right align-middle bg-slate-800/50 font-mono font-medium text-emerald-400 text-xs col-total">R$ ${(p.totalPaid).toFixed(0)}</td>
                    <td class="p-2 text-right align-middle bg-slate-800/50 border-r border-slate-700 font-mono font-medium ${p.missing > 0 ? 'text-rose-400' : 'text-slate-600'} text-xs col-falta">R$ ${p.missing.toFixed(0)}</td>
                    ${editTd}
                `;
                tbody.appendChild(row);
            });
        }

        // --- EDIT MODAL ---
        function openEditModal(index) {
            if(!requireAdmin()) return;

            const p = participantsData[index];
            if(!p) return;
            
            tempEditPhotoBase64 = ''; 

            document.getElementById('modalParticipantName').innerText = p.name;
            
            const imgEl = document.getElementById('modalAvatarImg');
            const txtEl = document.getElementById('modalAvatarText');
            if (p.photo && p.photo.trim() !== "") {
                imgEl.src = p.photo;
                imgEl.classList.remove('hidden');
                txtEl.classList.add('hidden');
            } else {
                imgEl.classList.add('hidden');
                txtEl.classList.remove('hidden');
                txtEl.innerText = p.name.charAt(0);
            }

            document.getElementById('editParticipantIndex').value = index;
            document.getElementById('editFineValue').value = p.fine || 0;
            document.getElementById('editExtraValue').value = p.extra || 0;
            document.getElementById('editBirthdayMonth').value = (p.birthdayMonth === undefined || p.birthdayMonth === null) ? -1 : p.birthdayMonth;

            const container = document.getElementById('editMonthsContainer');
            container.innerHTML = '';
            p.months.forEach((val, idx) => {
                const div = document.createElement('div');
                div.className = "bg-slate-900 border border-slate-700 rounded p-2 flex flex-col items-center";
                div.innerHTML = `
                    <label class="text-[10px] uppercase text-slate-500 font-bold mb-1">${MONTH_ABBR[idx]}</label>
                    <input type="number" id="edit-month-${idx}" value="${val}" class="bg-transparent text-white text-center font-mono focus:outline-none border-b border-transparent focus:border-indigo-500 transition-colors w-full">
                `;
                container.appendChild(div);
            });
            document.getElementById('editPaymentModal').classList.remove('hidden');
            document.getElementById('editPaymentModal').classList.add('flex');
        }

        function closeEditModal() {
            document.getElementById('editPaymentModal').classList.add('hidden');
            document.getElementById('editPaymentModal').classList.remove('flex');
            document.getElementById('fineWarning').classList.add('hidden'); 
        }

        async function saveEditModal() {
            if(!requireAdmin()) return;

            const index = document.getElementById('editParticipantIndex').value;
            const p = participantsData[index];
            if(!p) return;
            
            // Capture monthly payments
            const oldTotalPaid = p.months.reduce((a,b)=>a+b,0); // Just months

            for(let i=0; i<12; i++) { p.months[i] = parseFloat(document.getElementById(`edit-month-${i}`).value) || 0; }
            
            p.fine = parseFloat(document.getElementById('editFineValue').value) || 0;
            p.extra = parseFloat(document.getElementById('editExtraValue').value) || 0;
            
            const bMonth = parseInt(document.getElementById('editBirthdayMonth').value);
            p.birthdayMonth = bMonth === -1 ? null : bMonth;

            if (tempEditPhotoBase64) {
                p.photo = tempEditPhotoBase64;
            }

            // --- LATE PAYMENT LOGIC (ON SAVE) ---
            const parts = fineConfig.deadline.split('/');
            const deadlineDate = new Date(parts[2], parts[1] - 1, parts[0]);
            deadlineDate.setHours(23, 59, 59, 999);
            const today = new Date();

            if (today > deadlineDate) {
                // If user didn't have a fine yet
                if (p.fine === 0) {
                    // Check if *before* this edit they were below threshold (using oldTotalPaid of months only)
                    if (oldTotalPaid < fineConfig.threshold) {
                        const apply = confirm(`‚ö†Ô∏è PAGAMENTO EM ATRASO DETECTADO!\n\nA data limite era ${fineConfig.deadline}.\nO participante tinha pago R$ ${oldTotalPaid} em mensalidades (abaixo do m√≠nimo de R$ ${fineConfig.threshold}).\n\nDeseja aplicar a MULTA (D√≠vida) de R$ ${fineConfig.value} automaticamente?`);
                        if (apply) {
                            p.fine = fineConfig.value;
                        }
                    }
                }
            }

            calculateTotalsAndRender();
            closeEditModal();
        }

        // --- ADMIN ---
        function renderMonthlyGoalsInputs() {
            const container = document.getElementById('monthlyGoalsContainer');
            container.innerHTML = '';
            monthlyGoals.forEach((val, idx) => {
                const div = document.createElement('div');
                div.className = "bg-slate-900 p-2 rounded border border-slate-700 flex flex-col";
                div.innerHTML = `
                    <label class="text-[10px] uppercase text-slate-500 font-bold mb-1">${MONTH_ABBR[idx]}</label>
                    <div class="flex items-center"><span class="text-xs text-slate-500 mr-1">R$</span><input type="number" id="goal-${idx}" value="${val}" onchange="updateTotalAnnualGoalUI()" class="bg-transparent text-white text-sm w-full font-mono focus:outline-none"></div>
                `;
                container.appendChild(div);
            });
        }

        function updateTotalAnnualGoalUI() {
            const inputs = document.querySelectorAll('[id^="goal-"]');
            let total = 0;
            inputs.forEach(input => total += parseFloat(input.value) || 0);
            document.getElementById('totalAnnualGoal').innerText = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        }

        function saveMonthlyGoals() {
            if(!requireAdmin()) return;

            const inputs = document.querySelectorAll('[id^="goal-"]');
            inputs.forEach((input, idx) => monthlyGoals[idx] = parseFloat(input.value) || 0);
            calculateTotalsAndRender();
            alert("Metas atualizadas!");
        }

        function renderAdminUserList() {
            const tbody = document.getElementById('adminUsersTableBody');
            tbody.innerHTML = '';
            participantsData.forEach((p, index) => {
                const row = document.createElement('tr');
                row.className = "hover:bg-slate-800 transition border-b border-slate-700 last:border-0";
                row.innerHTML = `
                    <td class="p-2 pl-4 text-white font-medium">${p.name}</td>
                    <td class="p-2 text-right font-mono text-emerald-400 text-xs">R$ ${p.totalPaid}</td>
                    <td class="p-2 text-center"><button onclick="removeParticipant(${index})" class="text-rose-400 hover:text-white hover:bg-rose-600 p-1.5 rounded transition"><i class="ph ph-trash"></i></button></td>
                `;
                tbody.appendChild(row);
            });
        }

        async function addParticipant() {
            if(!requireAdmin()) return;

            const name = document.getElementById('newUserName').value.trim();
            if (!name) return;
            
            const bMonthVal = document.getElementById('newUserBirthday').value;
            const bMonth = bMonthVal === "" ? null : parseInt(bMonthVal);

            participantsData.push({ 
                id: Date.now(), 
                name: name, 
                months: Array(12).fill(0), 
                extra: 0,
                fine: 0, 
                totalPaid: 0, 
                missing: 0,
                photo: tempAddPhotoBase64 || '', // Usa o base64 carregado
                birthdayMonth: bMonth
            });
            
            // Limpa campos e vars tempor√°rias
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserBirthday').value = '';
            document.getElementById('newUserPhotoFile').value = ''; 
            document.getElementById('newUserPhotoName').classList.add('hidden');
            tempAddPhotoBase64 = '';

            calculateTotalsAndRender();
            renderAdminUserList();
        }

        function removeParticipant(idx) {
            if(!requireAdmin()) return;

            if(confirm("Remover participante?")) { participantsData.splice(idx, 1); calculateTotalsAndRender(); renderAdminUserList(); }
        }

        // Logic for checking fines
        function checkAndApplyFinesAutomatic() {
            const deadlineStr = fineConfig.deadline;
            if (!deadlineStr) return;

            const parts = deadlineStr.split('/');
            const deadlineDate = new Date(parts[2], parts[1] - 1, parts[0]);
            deadlineDate.setHours(23, 59, 59, 999);
            const today = new Date();

            // S√≥ roda autom√°tico se a data limite J√Å PASSOU
            if (today > deadlineDate) {
                let appliedCount = 0;
                participantsData.forEach(p => { 
                    const monthlyPaid = p.months.reduce((a,b)=>a+b,0);
                    // Se pagou menos que o m√≠nimo (apenas mensalidades) E n√£o tem multa registrada
                    if (monthlyPaid < fineConfig.threshold && (p.fine || 0) === 0) { 
                        p.fine = fineConfig.value; 
                        appliedCount++; 
                    } 
                });
                
                if (appliedCount > 0) {
                    calculateTotalsAndRender();
                    // Opcional: Avisar discretamente
                    console.log(`Auditoria Autom√°tica: ${appliedCount} multas aplicadas por atraso.`);
                }
            }
        }

        function manualFineCheck() {
            if(!requireAdmin()) return;

            applyFineRules(); // Re-usa a fun√ß√£o do bot√£o que tem alerts
        }

        function applyFineRules() {
            saveFineConfig(); // Garante que config est√° salva
            
            const deadlineStr = fineConfig.deadline;
            const threshold = fineConfig.threshold;
            const fineVal = fineConfig.value;

            if(!threshold || !fineVal || !deadlineStr) { 
                alert("Preencha todos os campos da multa!"); return; 
            }

            const parts = deadlineStr.split('/');
            const deadlineDate = new Date(parts[2], parts[1] - 1, parts[0]);
            const today = new Date();
            deadlineDate.setHours(23, 59, 59, 999);
            today.setHours(0, 0, 0, 0);

            if (today <= deadlineDate) {
                const diasRestantes = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));
                const confirmApply = confirm(`ATEN√á√ÉO: A data limite (${deadlineStr}) ainda n√£o chegou! Faltam ${diasRestantes} dias.\n\nDeseja aplicar a multa ANTECIPADAMENTE em quem n√£o pagou?`);
                if (!confirmApply) return;
            }
            
            let count = 0;
            participantsData.forEach(p => { 
                const monthlyPaid = p.months.reduce((a,b)=>a+b,0);
                if (monthlyPaid < threshold && (p.fine || 0) === 0) { 
                    p.fine = fineVal; 
                    count++; 
                } 
            });
            
            calculateTotalsAndRender();
            document.getElementById('fineFeedback').innerText = `Auditoria conclu√≠da. ${count} multas aplicadas.`;
            setTimeout(() => document.getElementById('fineFeedback').innerText = "", 4000);
        }

        // CSV Logic
        const fileInput = document.getElementById('csvInput');
        fileInput.addEventListener('change', (e) => {
            
            if(!isAdmin) { alert('Acesso restrito: somente Admin pode importar CSV.'); e.target.value=''; return; }
const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => parseCSV(evt.target.result);
            reader.readAsText(file);
        });

        function parseCSV(text) {
            if(!requireAdmin()) return;

            const lines = text.split('\n');
            const newData = [];
            const MONTHS_CSV = ['MARCO', 'ABRIL', 'MAIO', 'JUNHO', 'JULHO', 'AGOSTO', 'SETEMBRO', 'OUTUBRO', 'NOVEMBRO', 'DEZEMBRO'];
            let headerIdx = lines.findIndex(l => l.toUpperCase().includes('PAGANTES'));
            if (headerIdx === -1) { alert("CSV Inv√°lido."); return; }
            const headers = lines[headerIdx].split(',').map(h => h.trim().toUpperCase());
            const monthIndices = MONTHS_CSV.map(m => headers.indexOf(m));
            const nameIdx = headers.indexOf('PAGANTES');
            // Assuming "EXTRA/MULTA" in CSV corresponds to extra PAID, not debt.
            const extraIdx = headers.findIndex(h => h.includes('EXTRA') || h.includes('MULTA'));

            for(let i = headerIdx + 1; i < lines.length; i++) {
                const cols = lines[i].split(',');
                if (!cols[nameIdx] || cols[nameIdx].trim() === '' || cols[nameIdx] === 'PAGANTES') continue;
                let monthsValues = [0, 0]; 
                monthIndices.forEach(idx => { monthsValues.push(idx !== -1 ? (parseFloat(cols[idx]) || 0) : 0); });
                newData.push({ 
                    id: i, 
                    name: cols[nameIdx], 
                    months: monthsValues, 
                    extra: parseFloat(cols[extraIdx]) || 0, 
                    fine: 0, // Default fine debt is 0
                    totalPaid: 0, 
                    missing: 0,
                    photo: '', 
                    birthdayMonth: null 
                });
            }
            participantsData = newData;
            calculateTotalsAndRender();
            alert("Importado! Configure os anivers√°rios manualmente.");
        }

        
        function csvEscape(v) {
            if (v === null || v === undefined) return '';
            const s = String(v);
            if (/[",\n\r]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
            return s;
        }

        function exportParticipantsCSV() {
            if (!Array.isArray(participantsData)) return;

            const headers = [
                'id','nome',
                'jan','fev','mar','abr','mai','jun','jul','ago','set','out','nov','dez',
                'multa','extra','total_pago','falta',
                'aniversario_mes'
            ];

            const rows = participantsData.map(p => {
                const months = Array.isArray(p.months) ? p.months : Array(12).fill(0);
                const fine = Number(p.fine || 0);
                const extra = Number(p.extra || 0);
                const totalPaid = Number(p.totalPaid || 0);
                const missing = Number(p.missing || 0);
                const birthdayMonth = (p.birthdayMonth === 0 || p.birthdayMonth) ? (Number(p.birthdayMonth) + 1) : '';

                return [
                    p.id ?? '',
                    p.name ?? '',
                    ...months.map(v => Number(v || 0)),
                    fine,
                    extra,
                    totalPaid,
                    missing,
                    birthdayMonth
                ];
            });

            const csv = [headers.join(','), ...rows.map(r => r.map(csvEscape).join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'natal_familia_2026_export.csv';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        document.getElementById('exportCsvBtn')?.addEventListener('click', () => {
            if (!requireAdmin()) return;
            exportParticipantsCSV();
        });

document.getElementById('searchInput').addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = participantsData.filter(p => p.name.toLowerCase().includes(term));
            renderTable(filtered);
        });
    </script>
</body>
</html>