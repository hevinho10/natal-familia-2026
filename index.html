<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Natal Fam√≠lia 2026</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÖ</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- √çcones -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Calend√°rio -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>
    
    <!-- SUPABASE -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: { dark: { 900: '#0B0E14', 800: '#151923', 700: '#2A2F3E' }, brand: { 500: '#6366F1', 600: '#4F46E5' } }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0B0E14; color: #E2E8F0; }

        .login-bg { background: radial-gradient(circle at top, #1e1b4b, #0f172a); }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); }
        .card { background-color: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; padding: 1.5rem; }
        .tab-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500; color: #94a3b8; transition: all 0.2s; }
        .tab-btn:hover { color: white; background-color: #334155; }
        .tab-btn.active { background-color: #4f46e5; color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2); }
        .status-badge { font-size: 0.75rem; font-weight: 600; padding: 1px 0; width: 100%; display: block; border-radius: 4px; text-align: center; }
        .bg-paid { background: rgba(16, 185, 129, 0.15); color: #34D399; border: 1px solid rgba(16, 185, 129, 0.2); }
        .bg-partial { background: rgba(245, 158, 11, 0.15); color: #FBBF24; border: 1px solid rgba(245, 158, 11, 0.2); }
        .bg-missed { background: rgba(244, 63, 94, 0.15); color: #FB7185; border: 1px solid rgba(244, 63, 94, 0.2); }
        .bg-none { background: rgba(255, 255, 255, 0.03); color: #64748B; border: 1px dashed rgba(255, 255, 255, 0.1); }
        .bg-birthday { background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), rgba(168, 85, 247, 0.15)); color: #f472b6; border: 1px solid rgba(236, 72, 153, 0.3); display: flex; justify-content: center; align-items: center; gap: 2px; }
        .input-dark { background-color: #0f172a; border: 1px solid #334155; color: white; border-radius: 0.5rem; padding: 0.6rem 0.75rem; width: 100%; font-size: 0.875rem; transition: all 0.2s; }
        .input-dark:focus { outline: none; border-color: #6366f1; ring: 1px #6366f1; background-color: #161b28; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        th.sticky-col, td.sticky-col { position: sticky; left: 0; z-index: 20; background-color: #1e293b; box-shadow: 2px 0 5px rgba(0,0,0,0.2); }
        tr:hover td.sticky-col { background-color: #334155; }
        .profile-pic { object-fit: cover; width: 100%; height: 100%; }
        #loadingOverlay { background: rgba(15, 23, 42, 0.95); z-index: 200; position: fixed; inset: 0; display: flex; justify-content: center; align-items: center; color: white; flex-direction: column; backdrop-filter: blur(5px); }
        body.role-user .admin-only { display: none !important; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-dot.online { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }
        .status-dot.offline { background-color: #f59e0b; }
    </style>
</head>
<body class="flex flex-col min-h-screen font-sans">

    <!-- TELA DE LOGIN (Primeira coisa que aparece) -->
    <div id="loginScreen" class="fixed inset-0 z-[100] login-bg flex flex-col items-center justify-center p-4">
        <div class="relative w-full max-w-md glass-card rounded-2xl overflow-hidden shadow-2xl fade-in">
            <div class="h-1 w-full bg-gradient-to-r from-rose-500 via-indigo-500 to-emerald-500"></div>
            <div class="p-8">
                <div class="text-center mb-8">
                    <div class="inline-flex bg-slate-800/50 p-3 rounded-2xl border border-white/10 shadow-lg mb-4 animate-bounce">
                        <span class="text-4xl">üéÖ</span>
                    </div>
                    <h1 class="text-3xl font-bold text-white tracking-tight">Natal Fam√≠lia <span class="text-indigo-400">2026</span></h1>
                    <p class="text-slate-400 text-sm mt-2">Gest√£o Financeira & Metas</p>
                </div>
                
                <form onsubmit="handleLogin(event)" class="space-y-5">
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Usu√°rio</label>
                        <input type="text" id="loginUser" class="input-dark pl-4 !bg-slate-800/50 !border-slate-600 focus:!border-indigo-500 placeholder-slate-500" placeholder="Ex: admin" required>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Senha</label>
                        <input type="password" id="loginPass" class="input-dark pl-4 !bg-slate-800/50 !border-slate-600 focus:!border-indigo-500 placeholder-slate-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <p id="loginError" class="text-rose-400 text-xs text-center font-bold h-4"></p>
                    <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-500 hover:to-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg transition-all transform hover:scale-[1.02] active:scale-95">
                        ENTRAR
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Loading (S√≥ aparece DEPOIS do login) -->
    <div id="loadingOverlay" class="hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mb-4"></div>
        <p class="animate-pulse text-indigo-300 font-medium">Acessando Nuvem...</p>
        <p class="text-xs text-slate-500 mt-2" id="loadingText">Sincronizando...</p>
        <div id="errorDetails" class="hidden mt-4 bg-rose-900/50 p-4 rounded text-xs text-rose-300 max-w-sm text-center border border-rose-500/30"></div>
        <button id="retryBtn" onclick="location.reload()" class="hidden mt-4 bg-white/10 hover:bg-white/20 px-4 py-2 rounded text-sm text-white transition">Tentar Novamente</button>
    </div>

    <!-- Navbar Principal -->
    <nav id="mainNavbar" class="hidden bg-slate-800 border-b border-slate-700 sticky top-0 z-50 h-16 shadow-md">
        <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-rose-600 p-1.5 rounded-lg shadow-lg flex items-center justify-center w-10 h-10 ring-2 ring-rose-900/50"><span class="text-2xl leading-none">üéÖ</span></div>
                <h1 class="text-lg font-bold text-white tracking-tight hidden sm:block">Natal Fam√≠lia 2026</h1>
            </div>
            <div class="flex items-center gap-4">
                <span id="connectionStatus" class="text-xs text-slate-500 hidden sm:flex items-center"><span class="status-dot online"></span> Online</span>
                <div class="flex bg-slate-900/50 p-1 rounded-lg border border-slate-700">
                    <button onclick="switchTab('dashboard')" id="btn-dashboard" class="tab-btn active"><i class="ph ph-chart-pie-slice mr-1"></i> <span class="hidden sm:inline">Painel</span></button>
                    <button onclick="switchTab('admin')" id="btn-admin" class="tab-btn admin-only"><i class="ph ph-gear mr-1"></i> <span class="hidden sm:inline">Configurar</span></button>
                </div>
                <div class="h-6 w-px bg-slate-700 mx-1"></div>
                <button onclick="handleLogout()" class="text-slate-400 hover:text-white transition p-2 rounded hover:bg-slate-700" title="Sair"><i class="ph ph-sign-out text-xl"></i></button>
            </div>
        </div>
    </nav>

    <!-- Conte√∫do Principal -->
    <main id="mainContent" class="hidden flex-grow p-4 sm:p-6 w-full max-w-7xl mx-auto space-y-6">
        
        <!-- DASHBOARD -->
        <div id="view-dashboard" class="fade-in space-y-6">
            <div class="flex flex-col sm:flex-row justify-between items-end sm:items-center gap-4">
                <div><h2 class="text-xl font-bold text-white">Vis√£o Geral</h2><p class="text-sm text-slate-400">Acompanhamento financeiro.</p></div>
                <div class="flex gap-2 admin-only">
                    <label class="cursor-pointer bg-slate-800 hover:bg-slate-700 border border-slate-600 text-slate-300 px-4 py-2 rounded text-xs font-bold uppercase transition flex items-center gap-2"><i class="ph ph-file-csv text-green-400 text-lg"></i> Importar CSV<input type="file" id="csvInput" accept=".csv" class="hidden"></label>
                </div>
            </div>

            <div id="dashboardSummary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>

            <div class="card overflow-hidden !p-0 border border-slate-700 shadow-xl">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800 gap-4">
                    <h3 class="text-sm font-bold text-white flex items-center gap-2"><i class="ph ph-users text-indigo-400 text-lg"></i> Detalhamento</h3>
                    <input type="text" id="searchInput" placeholder="Buscar participante..." class="input-dark !w-full !py-1.5 !pl-9 !text-xs !bg-slate-900">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-900 text-slate-400 text-[10px] uppercase font-bold border-b border-slate-700 tracking-wider">
                                <th class="p-3 sticky-col min-w-[180px] text-slate-300 pl-4 text-xs">Participante</th>
                                <th class="p-1 text-center w-12">Jan</th><th class="p-1 text-center w-12">Fev</th><th class="p-1 text-center w-12">Mar</th>
                                <th class="p-1 text-center w-12">Abr</th><th class="p-1 text-center w-12">Mai</th><th class="p-1 text-center w-12">Jun</th>
                                <th class="p-1 text-center w-12">Jul</th><th class="p-1 text-center w-12">Ago</th><th class="p-1 text-center w-12">Set</th>
                                <th class="p-1 text-center w-12">Out</th><th class="p-1 text-center w-12">Nov</th><th class="p-1 text-center w-12">Dez</th>
                                <th class="p-1 text-center bg-rose-900/10 border-l border-rose-900/20 text-rose-400 min-w-[60px]">Multa</th>
                                <th class="p-1 text-center bg-indigo-900/10 border-l border-indigo-900/20 text-indigo-400 min-w-[60px]">Extra</th>
                                <th class="p-2 text-right bg-slate-800/50 min-w-[80px]">Total</th>
                                <th class="p-2 text-right bg-slate-800/50 border-r border-slate-700 min-w-[80px]">Falta</th>
                                <th class="p-2 text-center w-12 sticky right-0 z-20 bg-slate-800 admin-only">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="participantsTableBody" class="text-sm divide-y divide-slate-700 bg-slate-800"></tbody>
                    </table>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="card lg:col-span-1 flex flex-col items-center justify-center">
                    <h3 class="text-sm font-bold text-slate-400 w-full mb-4 flex items-center gap-2 border-b border-slate-700 pb-2"><i class="ph ph-chart-donut text-indigo-400"></i> Quita√ß√£o</h3>
                    <div class="relative w-48 h-48 my-4">
                        <svg class="w-full h-full transform -rotate-90" viewBox="0 0 36 36"><path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#334155" stroke-width="2" /><path id="pieChartPath" d="" fill="none" stroke="#6366f1" stroke-width="2" stroke-dasharray="0, 100" class="transition-all duration-1000 ease-out" /></svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center"><span id="pieChartPercent" class="text-3xl font-bold text-white">0%</span><span class="text-xs text-slate-500 uppercase tracking-widest font-bold">Pago</span></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 w-full mt-2">
                        <div class="bg-slate-900 p-2 rounded text-center border border-slate-700"><span id="countOk" class="block text-lg font-bold text-emerald-400">0</span><span class="text-[10px] uppercase text-slate-500 font-bold">Em dia</span></div>
                        <div class="bg-slate-900 p-2 rounded text-center border border-slate-700"><span id="countPending" class="block text-lg font-bold text-rose-400">0</span><span class="text-[10px] uppercase text-slate-500 font-bold">Pendente</span></div>
                    </div>
                </div>
                <div class="card lg:col-span-2 flex flex-col justify-between">
                    <div>
                        <h3 class="text-sm font-bold text-slate-400 mb-6 flex items-center gap-2 border-b border-slate-700 pb-2"><i class="ph ph-trend-up text-emerald-400"></i> Evolu√ß√£o</h3>
                        <div class="flex justify-between text-sm text-slate-300 mb-2"><span>Progresso Atual</span><span id="metaLabel" class="font-mono text-slate-400">Meta: R$ 0</span></div>
                        <div class="w-full bg-slate-900 rounded-full h-8 border border-slate-700 relative overflow-hidden"><div id="mainProgressBar" class="bg-gradient-to-r from-emerald-600 to-teal-500 h-full flex items-center justify-end pr-3 text-xs font-bold text-white shadow-[0_0_10px_rgba(16,185,129,0.3)] transition-all duration-1000" style="width: 0%">0%</div></div>
                    </div>
                    <div class="grid grid-cols-3 gap-4 mt-8">
                        <div class="bg-slate-900 p-4 rounded-lg border border-slate-700 text-center"><p class="text-[10px] text-slate-500 font-bold uppercase mb-1">Esperado Total</p><p id="summaryTotalExpected" class="text-lg font-bold text-white">R$ 0</p></div>
                        <div class="bg-slate-900 p-4 rounded-lg border border-slate-700 text-center"><p class="text-[10px] text-slate-500 font-bold uppercase mb-1">Confirmado</p><p id="summaryTotalPaid" class="text-lg font-bold text-emerald-400">R$ 0</p></div>
                        <div class="bg-slate-900 p-4 rounded-lg border border-slate-700 text-center"><p class="text-[10px] text-slate-500 font-bold uppercase mb-1">Em Aberto</p><p id="summaryTotalMissing" class="text-lg font-bold text-rose-400">R$ 0</p></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ADMIN -->
        <div id="viewAdmin" class="hidden fade-in space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-6">
                    <h3 class="font-bold text-white mb-4 flex items-center gap-2"><i class="ph ph-currency-dollar text-indigo-400"></i> Metas Mensais</h3>
                    <div id="goalsInputs" class="grid grid-cols-4 gap-3"></div>
                    <div class="mt-4 pt-4 border-t border-slate-700 flex justify-end">
                        <button onclick="saveAll()" class="bg-indigo-600 text-white px-4 py-2 rounded text-xs font-bold uppercase hover:bg-indigo-500">Salvar Metas</button>
                    </div>
                </div>
                <div class="bg-slate-800 border border-slate-700 rounded-xl p-6">
                    <h3 class="font-bold text-white mb-4 flex items-center gap-2"><i class="ph ph-user-plus text-emerald-400"></i> Adicionar Pessoa</h3>
                    <div class="flex gap-2 mb-4">
                        <input id="newName" type="text" class="input-dark" placeholder="Nome Completo">
                        <button onclick="addUser()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 rounded font-bold shadow">+</button>
                    </div>
                    <div class="space-y-4 pt-4 border-t border-slate-700">
                         <h3 class="font-bold text-white text-sm flex items-center gap-2"><i class="ph ph-siren text-rose-400"></i> Multa Autom√°tica</h3>
                         <div class="grid grid-cols-3 gap-2">
                            <input id="fineDate" type="text" class="input-dark text-center" placeholder="Data">
                            <input id="fineMin" type="number" class="input-dark text-center" placeholder="Min R$">
                            <input id="fineVal" type="number" class="input-dark text-center" placeholder="Multa R$">
                         </div>
                         <button onclick="runFineCheck()" class="w-full bg-rose-900/30 text-rose-300 border border-rose-500/30 py-2 rounded text-xs font-bold uppercase hover:bg-rose-900/50">Verificar Atrasos</button>
                         <p id="fineMsg" class="text-center text-xs text-rose-400 h-4"></p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL EDITAR -->
    <div id="editModal" class="hidden fixed inset-0 z-[100] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-slate-800 border border-slate-600 rounded-xl w-full max-w-lg shadow-2xl transform transition-all scale-100 p-6 space-y-4">
            <div class="flex justify-between items-center border-b border-slate-700 pb-4">
                <h3 class="text-xl font-bold text-white" id="modalTitle">Editar</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="flex gap-4">
                <div class="w-20 h-20 bg-slate-700 rounded-full flex-shrink-0 overflow-hidden border-2 border-slate-500 relative group cursor-pointer">
                    <img id="modalImg" class="w-full h-full object-cover hidden">
                    <div id="modalInitial" class="w-full h-full flex items-center justify-center text-3xl font-bold text-slate-400">?</div>
                    <input type="file" id="modalFile" class="hidden" accept="image/*">
                    <div onclick="document.getElementById('modalFile').click()" class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center text-white text-xs">FOTO</div>
                </div>
                <div class="flex-grow space-y-2">
                    <label class="text-[10px] uppercase font-bold text-slate-500">M√™s Anivers√°rio</label>
                    <select id="modalBirthday" class="input-dark p-1.5 text-xs">
                        <option value="-1">-- Nenhum --</option>
                        <option value="0">Janeiro</option><option value="1">Fevereiro</option><option value="2">Mar√ßo</option>
                        <option value="3">Abril</option><option value="4">Maio</option><option value="5">Junho</option>
                        <option value="6">Julho</option><option value="7">Agosto</option><option value="8">Setembro</option>
                        <option value="9">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-4 gap-2" id="modalMonths"></div>
            <div class="grid grid-cols-2 gap-4 pt-2 border-t border-slate-700">
                <div><label class="text-[10px] text-rose-400 font-bold block mb-1">MULTA (D√çVIDA)</label><input type="number" id="modalFine" class="input-dark border-rose-500/30 text-rose-400 font-bold text-right"></div>
                <div><label class="text-[10px] text-indigo-400 font-bold block mb-1">EXTRA (PAGO)</label><input type="number" id="modalExtra" class="input-dark border-indigo-500/30 text-indigo-400 font-bold text-right"></div>
            </div>
            <button onclick="saveModal()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg shadow-lg">SALVAR ALTERA√á√ïES</button>
        </div>
    </div>

    <!-- SCRIPT -->
    <script>
        const SUPABASE_URL = 'https://nctjowqvtbejbipxhhd.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5jdGpvd3F1YnRmYmVqaXB4aGhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczODk1NjYsImV4cCI6MjA4Mjk2NTU2Nn0.63GaaShzKx0oO6n4ci0Rj3onmenYycjcE0EN7vVvErE';
        
        let dbClient = null;
        let data = { users: [], goals: [0,0,30,30,30,30,30,30,30,30,55,55], fine: { date: '2026-05-20', min: 50, val: 15 } };
        const MONTHS = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
        let currentUserRole = null;
        let tempPhoto = '';
        let editingIdx = -1;

        window.onload = async () => {
            try { dbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e) {}
            flatpickr("#fineDate", { dateFormat: "d/m/Y", defaultDate: data.fine.date });
            document.getElementById('loginForm').onsubmit = (e) => {
                e.preventDefault();
                const u = document.getElementById('loginUser').value.trim();
                const p = document.getElementById('loginPass').value.trim();
                if (u === 'admin' && p === 'Admin2026') login('admin');
                else if (u === 'Natal' && p === '2026') login('user');
                else document.getElementById('loginError').innerText = "Dados incorretos";
            };
        };

        function login(role) {
            currentUserRole = role;
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('appContent').classList.remove('hidden');
            document.body.classList.add(`role-${role}`);
            
            if(role !== 'admin') document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'none');
            
            // S√≥ carrega dados depois do login
            loadDataChain();
        }

        function handleLogout() { location.reload(); }

        async function loadDataChain() {
            if(!dbClient) { finishLoading(); return; }
            try {
                const { data: res, error } = await dbClient.from('natal_2026').select('conteudo').eq('id', 1).single();
                if(res && res.conteudo) {
                    data = res.conteudo;
                    if(!data.users) data.users = [];
                    if(!data.goals) data.goals = [0,0,30,30,30,30,30,30,30,30,55,55];
                } else {
                    // Tabela vazia, cria registro
                    await saveData();
                }
                document.getElementById('statusMsg').innerText = "Online";
                updateStatus('online');
            } catch (e) {
                console.warn("Erro ao carregar:", e);
                document.getElementById('errorDetails').innerText = e.message;
                document.getElementById('errorDetails').classList.remove('hidden');
                document.getElementById('retryBtn').classList.remove('hidden');
                return; // Para aqui se der erro
            }
            finishLoading();
        }

        function finishLoading() {
            renderUI();
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        async function saveData() {
            if (!dbClient) return;
            const payload = { users: data.users, goals: data.goals, fine: data.fine };
            const { error } = await dbClient.from('natal_2026').upsert({ id: 1, tipo: 'dados_gerais', conteudo: payload });
            if (error) alert("Erro ao salvar: " + error.message);
        }

        function renderUI() {
            // Tabela
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            if(data.users.length === 0) {
                tbody.innerHTML = `<tr><td colspan="18" class="p-8 text-center text-slate-500 italic">Nenhum registro. <br>Cadastre em Configurar.</td></tr>`;
            } else {
                let totalArr = 0, totalEsp = 0, totalFalta = 0;
                data.users.forEach((p, idx) => {
                    let htmlMonths = '';
                    let paidSum = 0;
                    let userGoal = data.goals.reduce((a,b)=>a+b,0);
                    if(p.birthday > -1 && p.birthday < 12) userGoal -= data.goals[p.birthday];

                    p.months.forEach((val, mIdx) => {
                        const goal = data.goals[mIdx];
                        let badge = 'bg-none'; let txt = val > 0 ? val : '-';
                        if(p.birthday == mIdx) { badge = 'bg-birthday'; txt = 'üéÇ'; if(val>0) txt+=` ${val}`; }
                        else if(goal > 0) { if(val >= goal) badge='bg-paid'; else if(val>0) badge='bg-partial'; else badge='bg-missed'; }
                        else if(val > 0) badge='bg-paid';
                        
                        paidSum += val;
                        htmlMonths += `<td class="p-1 text-center"><span class="status-badge ${badge}">${txt}</span></td>`;
                    });

                    const totalPaid = paidSum + (p.extra || 0);
                    const totalDebt = userGoal + (p.fine || 0);
                    const missing = Math.max(0, totalDebt - totalPaid);
                    totalArr += totalPaid; totalEsp += totalDebt; totalFalta += missing;

                    let avatar = `<div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold border border-slate-600 text-slate-300">${p.name[0]}</div>`;
                    if(p.photo && p.photo.length > 50) avatar = `<img src="${p.photo}" class="w-8 h-8 rounded-full object-cover border border-slate-500">`;

                    const row = document.createElement('tr');
                    row.className = "hover:bg-slate-700/50 border-b border-slate-700 last:border-0 transition group";
                    row.innerHTML = `<td class="p-2 sticky-col z-20 font-medium text-white flex items-center gap-3 pl-4"><div class="cursor-pointer hover:scale-110 transition" onclick="openModal(${idx})">${avatar}</div>${p.name}</td>${htmlMonths}<td class="p-1 text-center bg-rose-900/10 text-rose-400 font-bold text-xs border-l border-white/5">${p.fine>0?'R$'+p.fine:'-'}</td><td class="p-1 text-center bg-indigo-900/10 text-indigo-400 font-bold text-xs border-l border-white/5">${p.extra>0?'+'+p.extra:'-'}</td><td class="p-2 text-right bg-white/5 font-mono text-emerald-400 text-xs font-bold">R$ ${totalPaid}</td><td class="p-2 text-right bg-white/5 font-mono text-xs ${missing>0?'text-rose-400':'text-slate-500'}">R$ ${missing}</td><td class="p-2 text-center sticky right-0 z-20 bg-slate-800 admin-only shadow-[-5px_0_10px_rgba(0,0,0,0.3)]"><button onclick="openModal(${idx})" class="text-indigo-400 hover:text-white p-1.5 rounded hover:bg-indigo-600 transition"><i class="ph ph-pencil-simple text-lg"></i></button></td>`;
                    tbody.appendChild(row);
                });

                const okCount = data.users.filter(p => {
                    let g = data.goals.reduce((a,b)=>a+b,0);
                    if(p.birthday > -1) g -= data.goals[p.birthday];
                    return ((p.months.reduce((a,b)=>a+b,0) + (p.extra||0)) >= (g + (p.fine||0)));
                }).length;
                
                document.getElementById('dashboardSummary').innerHTML = `
                    <div class="card border-l-4 border-l-emerald-500"><p class="text-slate-400 text-[10px] font-bold uppercase">Caixa Atual</p><h2 class="text-2xl font-bold text-white mt-1">R$ ${totalArr.toLocaleString()}</h2></div>
                    <div class="card border-l-4 border-l-rose-500"><p class="text-slate-400 text-[10px] font-bold uppercase">Falta Receber</p><h2 class="text-2xl font-bold text-white mt-1">R$ ${totalFalta.toLocaleString()}</h2></div>
                    <div class="card border-l-4 border-l-indigo-500"><p class="text-slate-400 text-[10px] font-bold uppercase">Participantes</p><div class="flex items-end gap-2 mt-1"><h2 class="text-2xl font-bold text-white">${data.users.length}</h2><span class="text-xs text-indigo-400 font-bold mb-1 px-2 rounded bg-indigo-900/30">${okCount} Quitados</span></div></div>
                    <div class="card border-l-4 border-l-amber-500"><p class="text-slate-400 text-[10px] font-bold uppercase">Extra Arrecadado</p><h2 class="text-2xl font-bold text-white mt-1">R$ ${data.users.reduce((acc, p) => acc + (p.extra || 0), 0).toLocaleString()}</h2></div>
                `;
                
                // Charts
                document.getElementById('pieChartPercent').innerText = (totalEsperado>0 ? (totalArr/totalEsperado)*100 : 0).toFixed(0) + '%';
                document.getElementById('pieChartPath').setAttribute('stroke-dasharray', `${(totalEsperado>0 ? (totalArr/totalEsperado)*100 : 0)}, 100`);
                document.getElementById('countOk').innerText = okCount;
                document.getElementById('countPending').innerText = data.users.length - okCount;
                document.getElementById('mainProgressBar').style.width = `${(totalEsperado>0 ? (totalArr/totalEsperado)*100 : 0)}%`;
                document.getElementById('metaLabel').innerText = `Meta: R$ ${totalEsperado.toLocaleString()}`;
                document.getElementById('summaryTotalExpected').innerText = `R$ ${totalEsperado.toLocaleString()}`;
                document.getElementById('summaryTotalPaid').innerText = `R$ ${totalArr.toLocaleString()}`;
                document.getElementById('summaryTotalMissing').innerText = `R$ ${totalFalta.toLocaleString()}`;
            }

            // Admin
            const goalsContainer = document.getElementById('goalsInputs');
            goalsContainer.innerHTML = '';
            data.goals.forEach((val, idx) => {
                goalsContainer.innerHTML += `<div><label class="text-[10px] text-slate-500 uppercase font-bold">${MONTHS[idx]}</label><input type="number" class="input-dark goal-input" data-idx="${idx}" value="${val}"></div>`;
            });
            document.getElementById('fineDate').value = data.fine.date;
            document.getElementById('fineMin').value = data.fine.min;
            document.getElementById('fineVal').value = data.fine.val;

            if (currentUserRole !== 'admin') document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'none');
            else document.querySelectorAll('.admin-only').forEach(e => e.style.display = '');
        }

        // --- FUN√á√ïES ---
        function addUser() {
            const name = document.getElementById('newName').value.trim();
            if (!name) return alert("Digite um nome");
            data.users.push({ name, months: [0,0,0,0,0,0,0,0,0,0,0,0], fine: 0, extra: 0, photo: '', birthday: -1 });
            document.getElementById('newName').value = '';
            renderUI(); saveData(); alert("Adicionado!");
        }

        function runFineCheck() {
            const dStr = document.getElementById('fineDate').value;
            const min = parseFloat(document.getElementById('fineMin').value)||0;
            const val = parseFloat(document.getElementById('fineVal').value)||0;
            const parts = dStr.split('/'); const deadline = new Date(parts[2], parts[1]-1, parts[0]); deadline.setHours(23,59,59);
            const today = new Date(); today.setHours(0,0,0);
            if(today <= deadline && !confirm(`Data limite (${dStr}) ainda n√£o chegou. Aplicar mesmo assim?`)) return;
            let count = 0;
            data.users.forEach(p => {
                const paid = p.months.reduce((a,b)=>a+b,0);
                if(paid < min && p.fine === 0) { p.fine = val; count++; }
            });
            renderUI(); saveData(); alert(`${count} multas aplicadas.`);
        }

        // Modal
        function openModal(idx) {
            if(currentUserRole !== 'admin') return;
            editingIdx = idx;
            const p = data.users[idx];
            document.getElementById('modalTitle').innerText = `Editar: ${p.name}`;
            document.getElementById('modalBirthday').value = p.birthday;
            tempPhoto = p.photo || '';
            const img = document.getElementById('modalImg'); const init = document.getElementById('modalInitial');
            if (tempPhoto) { img.src = tempPhoto; img.classList.remove('hidden'); init.classList.add('hidden'); }
            else { img.classList.add('hidden'); init.classList.remove('hidden'); init.innerText = p.name[0]; }
            const mc = document.getElementById('modalMonths'); mc.innerHTML = '';
            p.months.forEach((val, i) => { mc.innerHTML += `<div><label class="text-[10px] text-slate-500 uppercase">${MONTHS[i]}</label><input type="number" class="input-dark modal-month-input" data-idx="${i}" value="${val}"></div>`; });
            document.getElementById('modalFine').value = p.fine || 0;
            document.getElementById('modalExtra').value = p.extra || 0;
            document.getElementById('editModal').classList.remove('hidden'); document.getElementById('editModal').classList.add('flex');
        }
        document.getElementById('modalFile').addEventListener('change', function() {
            if(this.files && this.files[0]) {
                const r = new FileReader();
                r.onload = (e) => { tempPhoto = e.target.result; document.getElementById('modalImg').src = tempPhoto; document.getElementById('modalImg').classList.remove('hidden'); document.getElementById('modalInitial').classList.add('hidden'); };
                r.readAsDataURL(this.files[0]);
            }
        });
        function saveModal() {
            const p = data.users[editingIdx];
            document.querySelectorAll('.modal-month-input').forEach(inp => p.months[parseInt(inp.dataset.idx)] = parseFloat(inp.value)||0);
            p.birthday = parseInt(document.getElementById('modalBirthday').value);
            p.fine = parseFloat(document.getElementById('modalFine').value)||0;
            p.extra = parseFloat(document.getElementById('modalExtra').value)||0;
            p.photo = tempPhoto;
            closeModal(); renderUI(); saveData();
        }
        function closeModal() { document.getElementById('editModal').classList.add('hidden'); document.getElementById('editModal').classList.remove('flex'); }

        // Utils
        function switchTab(t) {
            const d=document.getElementById('viewDashboard'), a=document.getElementById('viewAdmin'), bd=document.getElementById('btn-dashboard'), ba=document.getElementById('btn-admin');
            d.classList.add('hidden'); a.classList.add('hidden'); bd.classList.remove('active'); ba.classList.remove('active');
            if(t==='dashboard') { d.classList.remove('hidden'); bd.classList.add('active'); }
            else { a.classList.remove('hidden'); ba.classList.add('active'); }
        }
        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            const rows = document.getElementById('tableBody').querySelectorAll('tr');
            rows.forEach(r => { r.style.display = r.innerText.toLowerCase().includes(term) ? '' : 'none'; });
        });
        function resetData() { if(confirm("Apagar TUDO?")) { data.users=[]; data.goals=[0,0,0,0,0,0,0,0,0,0,0,0]; renderUI(); saveData(); } }
        function loadDemoData() { data.users = [{ name: 'Exemplo', months: [0,0,30,30,30,30,30,30,30,30,55,55], fine: 0, extra: 0, photo: '', birthday: 8 }]; renderUI(); saveData(); }
        // CSV
        const csvInput = document.getElementById('csvInput');
        if(csvInput) csvInput.addEventListener('change', (e) => {
            const file = e.target.files[0]; if (!file) return;
            const r = new FileReader();
            r.onload = (evt) => {
                const lines = evt.target.result.split('\n');
                let imported = 0;
                lines.forEach((line, idx) => {
                    if (idx > 0) { const cols = line.split(','); if (cols[0] && cols[0].trim()) { data.users.push({ name: cols[0].trim(), months: [0,0,0,0,0,0,0,0,0,0,0,0], fine: 0, extra: 0, photo: '', birthday: -1 }); imported++; } }
                });
                alert(`${imported} pessoas importadas!`); renderUI(); saveData();
            };
            r.readAsText(file);
        });
        function updateStatus(s) { const el = document.getElementById('connectionStatus'); if(el) el.innerHTML = s === 'online' ? '<span class="status-dot online"></span> Conectado' : '<span class="status-dot offline"></span> Offline'; }
    </script>
</body>
</html>