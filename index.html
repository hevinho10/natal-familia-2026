<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Natal Fam√≠lia 2026</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÖ</text></svg>">

    <!-- Estilos e Fontes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); }
        .input-dark { background-color: #0f172a; border: 1px solid #334155; color: white; border-radius: 0.5rem; padding: 0.6rem; width: 100%; font-size: 0.875rem; }
        .input-dark:focus { outline: none; border-color: #6366f1; ring: 1px #6366f1; }
        .status-badge { font-size: 0.75rem; font-weight: 600; padding: 2px 0; border-radius: 4px; text-align: center; display: block; }
        .bg-paid { background: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.2); }
        .bg-missed { background: rgba(248, 113, 113, 0.15); color: #f87171; border: 1px solid rgba(248, 113, 113, 0.2); }
        .bg-none { background: rgba(148, 163, 184, 0.1); color: #94a3b8; border: 1px dashed rgba(148, 163, 184, 0.2); }
        .bg-birthday { background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), rgba(168, 85, 247, 0.15)); color: #f472b6; border: 1px solid rgba(236, 72, 153, 0.3); display: flex; justify-content: center; align-items: center; }
        /* Utilit√°rios */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Login BG */
        .login-bg { background: radial-gradient(circle at top, #1e1b4b, #0f172a); }
        /* Sticky Column */
        th.sticky-col, td.sticky-col { position: sticky; left: 0; z-index: 20; background-color: #1e293b; box-shadow: 2px 0 5px rgba(0,0,0,0.3); }
        .profile-pic { object-fit: cover; width: 100%; height: 100%; }
        /* Loading Overlay */
        #loadingOverlay { background: rgba(15, 23, 42, 0.98); z-index: 999; position: fixed; inset: 0; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mb-4"></div>
        <p class="text-indigo-300 font-bold" id="loadingText">Conectando ao Banco de Dados...</p>
        <p class="text-xs text-slate-500 mt-2" id="debugText">Iniciando m√≥dulos...</p>
    </div>

    <!-- LOGIN -->
    <div id="loginScreen" class="fixed inset-0 z-50 login-bg flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md glass-card rounded-2xl overflow-hidden shadow-2xl fade-in p-8">
            <div class="text-center mb-8">
                <div class="inline-flex bg-slate-800/50 p-3 rounded-2xl border border-white/10 shadow-lg mb-4 text-4xl">üéÖ</div>
                <h1 class="text-2xl font-bold text-white">Natal Fam√≠lia 2026</h1>
                <p class="text-slate-400 text-xs mt-2 uppercase tracking-widest">Acesso Restrito</p>
            </div>
            <form id="loginForm" class="space-y-5">
                <div><label class="text-xs font-bold text-slate-500 block mb-1">USU√ÅRIO</label><input type="text" id="loginUser" class="input-dark" placeholder="admin ou natal" required></div>
                <div><label class="text-xs font-bold text-slate-500 block mb-1">SENHA</label><input type="password" id="loginPass" class="input-dark" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required></div>
                <p id="loginError" class="text-rose-400 text-xs text-center font-bold h-4"></p>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg transition shadow-lg">ENTRAR</button>
            </form>
        </div>
    </div>

    <!-- SISTEMA (Painel) -->
    <div id="appContainer" class="hidden flex flex-col min-h-screen">
        <nav class="bg-slate-800 border-b border-slate-700 h-16 flex items-center justify-between px-4 sticky top-0 z-40 shadow-md">
            <div class="flex items-center gap-3"><span class="text-2xl">üéÖ</span><h1 class="font-bold text-white hidden sm:block">Natal 2026</h1></div>
            <div class="flex gap-4 items-center">
                <span id="userBadge" class="text-xs font-bold text-indigo-400 border border-indigo-400/30 px-2 py-1 rounded bg-indigo-400/10">VISITANTE</span>
                <button id="btnLogout" class="text-slate-400 hover:text-white"><i class="ph ph-sign-out text-xl"></i></button>
            </div>
        </nav>

        <main class="flex-grow p-4 sm:p-6 w-full max-w-[1400px] mx-auto space-y-6">
            
            <!-- Abas / Controles -->
            <div class="flex justify-between items-center">
                <div class="flex bg-slate-900 rounded-lg p-1 border border-slate-700">
                    <button id="tabDash" class="px-4 py-1.5 rounded text-sm font-medium bg-indigo-600 text-white shadow">Painel</button>
                    <button id="tabAdmin" class="px-4 py-1.5 rounded text-sm font-medium text-slate-400 hover:text-white hidden">Configurar</button>
                </div>
                <div id="adminActions" class="hidden flex gap-2">
                    <button id="btnReset" class="text-xs text-rose-400 border border-rose-900 px-3 py-1 rounded hover:bg-rose-900/20"><i class="ph ph-trash"></i> Resetar</button>
                    <button id="btnSave" class="text-xs bg-emerald-600 text-white px-3 py-1 rounded font-bold hover:bg-emerald-500"><i class="ph ph-floppy-disk"></i> Salvar Tudo</button>
                </div>
            </div>

            <!-- VIEW: DASHBOARD -->
            <div id="viewDashboard" class="space-y-6 fade-in">
                <!-- Resumo -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="summaryCards"></div>
                
                <!-- Tabela -->
                <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden shadow-xl">
                    <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900/50">
                        <h3 class="text-sm font-bold text-white flex gap-2"><i class="ph ph-users text-indigo-400"></i> Detalhamento</h3>
                        <input id="search" type="text" placeholder="Buscar..." class="input-dark !w-48 !py-1 !text-xs">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-900 text-slate-400 text-[10px] uppercase font-bold border-b border-slate-700 tracking-wider">
                                    <th class="p-2 sticky-col min-w-[180px] text-slate-300 pl-4">Nome</th>
                                    <th class="p-1 text-center w-12">Jan</th><th class="p-1 text-center w-12">Fev</th><th class="p-1 text-center w-12">Mar</th>
                                    <th class="p-1 text-center w-12">Abr</th><th class="p-1 text-center w-12">Mai</th><th class="p-1 text-center w-12">Jun</th>
                                    <th class="p-1 text-center w-12">Jul</th><th class="p-1 text-center w-12">Ago</th><th class="p-1 text-center w-12">Set</th>
                                    <th class="p-1 text-center w-12">Out</th><th class="p-1 text-center w-12">Nov</th><th class="p-1 text-center w-12">Dez</th>
                                    <th class="p-1 text-center bg-rose-900/10 text-rose-400 w-16 border-l border-white/5">Multa</th>
                                    <th class="p-1 text-center bg-indigo-900/10 text-indigo-400 w-16 border-l border-white/5">Extra</th>
                                    <th class="p-2 text-right bg-white/5 w-20">Total</th>
                                    <th class="p-2 text-right bg-white/5 w-20 border-r border-white/5">Falta</th>
                                    <th class="p-2 text-center w-10 sticky right-0 z-20 bg-slate-800 shadow-[-5px_0_10px_rgba(0,0,0,0.3)]">Edit</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="text-xs divide-y divide-slate-700 bg-slate-800"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: ADMIN -->
            <div id="viewAdmin" class="hidden space-y-6 fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Config Metas -->
                    <div class="bg-slate-800 border border-slate-700 rounded-xl p-6">
                        <h3 class="font-bold text-white mb-4"><i class="ph ph-currency-dollar text-indigo-400"></i> Metas Mensais</h3>
                        <div id="goalsInputs" class="grid grid-cols-4 gap-3"></div>
                    </div>
                    <!-- Config Pessoas -->
                    <div class="bg-slate-800 border border-slate-700 rounded-xl p-6">
                        <h3 class="font-bold text-white mb-4"><i class="ph ph-user-plus text-emerald-400"></i> Adicionar Pessoa</h3>
                        <div class="flex gap-2 mb-4">
                            <input id="newName" type="text" class="input-dark" placeholder="Nome Completo">
                            <button id="btnAddUser" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 rounded font-bold">+</button>
                        </div>
                        <div class="space-y-4 pt-4 border-t border-slate-700">
                             <h3 class="font-bold text-white text-sm"><i class="ph ph-siren text-rose-400"></i> Multa Autom√°tica</h3>
                             <div class="grid grid-cols-3 gap-2">
                                <input id="fineDate" type="text" class="input-dark" placeholder="Data (20/05/2026)">
                                <input id="fineMin" type="number" class="input-dark" placeholder="M√≠nimo R$">
                                <input id="fineVal" type="number" class="input-dark" placeholder="Multa R$">
                             </div>
                             <button id="btnRunFine" class="w-full bg-rose-900/30 text-rose-300 border border-rose-500/30 py-2 rounded text-xs font-bold uppercase hover:bg-rose-900/50">Verificar Multas</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL EDITAR -->
    <div id="editModal" class="hidden fixed inset-0 z-[100] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-slate-800 border border-slate-600 rounded-xl w-full max-w-lg shadow-2xl transform transition-all scale-100 p-6 space-y-4">
            <div class="flex justify-between items-center border-b border-slate-700 pb-4">
                <h3 class="text-xl font-bold text-white" id="modalTitle">Editar</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white"><i class="ph ph-x text-xl"></i></button>
            </div>
            
            <div class="flex gap-4">
                <div class="w-20 h-20 bg-slate-700 rounded-full flex-shrink-0 overflow-hidden border-2 border-slate-500 relative group cursor-pointer">
                    <img id="modalImg" class="w-full h-full object-cover hidden">
                    <div id="modalInitial" class="w-full h-full flex items-center justify-center text-3xl font-bold text-slate-400">?</div>
                    <input type="file" id="modalFile" class="hidden" accept="image/*">
                    <div onclick="document.getElementById('modalFile').click()" class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center text-white text-xs">FOTO</div>
                </div>
                <div class="flex-grow space-y-2">
                    <label class="text-[10px] uppercase font-bold text-slate-500">M√™s Anivers√°rio</label>
                    <select id="modalBirthday" class="input-dark p-1.5 text-xs">
                        <option value="-1">-- Nenhum --</option>
                        <option value="0">Janeiro</option><option value="1">Fevereiro</option><option value="2">Mar√ßo</option>
                        <option value="3">Abril</option><option value="4">Maio</option><option value="5">Junho</option>
                        <option value="6">Julho</option><option value="7">Agosto</option><option value="8">Setembro</option>
                        <option value="9">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-4 gap-2" id="modalMonths"></div>
            
            <div class="grid grid-cols-2 gap-4 pt-2 border-t border-slate-700">
                <div><label class="text-[10px] text-rose-400 font-bold block mb-1">D√çVIDA MULTA</label><input type="number" id="modalFine" class="input-dark border-rose-500/30 text-rose-400"></div>
                <div><label class="text-[10px] text-indigo-400 font-bold block mb-1">PAGO EXTRA</label><input type="number" id="modalExtra" class="input-dark border-indigo-500/30 text-indigo-400"></div>
            </div>

            <button id="modalSave" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg">SALVAR ALTERA√á√ïES</button>
        </div>
    </div>

    <!-- M√ìDULO JS (IMPORTANTE: type="module" evita conflitos globais) -->
    <script type="module">
        // 1. IMPORTA√á√ÉO DO SUPABASE VIA M√ìDULO (Mais seguro e moderno)
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        import flatpickr from 'https://cdn.jsdelivr.net/npm/flatpickr/+esm';
        // import { Portuguese } from 'https://npmcdn.com/flatpickr/dist/l10n/pt.js'; // Flatpickr l10n is tricky in modules, we'll use english or manual config if needed, keeping it simple.

        // 2. CONFIGURA√á√ÉO (SUAS CHAVES REAIS)
        const SUPABASE_URL = 'https://nctjowqvtbejbipxhhd.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5jdGpvd3F1YnRmYmVqaXB4aGhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczODk1NjYsImV4cCI6MjA4Mjk2NTU2Nn0.63GaaShzKx0oO6n4ci0Rj3onmenYycjcE0EN7vVvErE';
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // 3. ESTADO DA APLICA√á√ÉO
        let state = {
            users: [],
            goals: [0,0,30,30,30,30,30,30,30,30,55,55], // Padr√£o
            fine: { date: '2026-05-20', min: 50, val: 15 },
            currentUser: null // 'admin' ou 'natal'
        };
        const MONTHS = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];

        // 4. ELEMENTOS DOM
        const ui = {
            loading: document.getElementById('loadingOverlay'),
            loadingTxt: document.getElementById('loadingText'),
            debug: document.getElementById('debugText'),
            login: document.getElementById('loginScreen'),
            app: document.getElementById('appContainer'),
            userBadge: document.getElementById('userBadge'),
            tabDash: document.getElementById('tabDash'),
            tabAdmin: document.getElementById('tabAdmin'),
            viewDash: document.getElementById('viewDashboard'),
            viewAdmin: document.getElementById('viewAdmin'),
            tableBody: document.getElementById('tableBody'),
            modal: document.getElementById('editModal'),
        };

        // 5. INICIALIZA√á√ÉO
        window.addEventListener('DOMContentLoaded', async () => {
            console.log("App Iniciado");
            
            // Tenta carregar dados IMEDIATAMENTE do banco
            await loadData();

            // Setup de eventos
            setupLogin();
            setupTabs();
            setupAdminActions();
        });

        // 6. CARREGAMENTO DE DADOS (SUPABASE ONLY)
        async function loadData() {
            ui.debug.innerText = "Buscando dados na nuvem...";
            
            try {
                // Busca a linha √∫nica de configura√ß√£o (ID 1)
                const { data, error } = await supabase.from('natal_2026').select('conteudo').eq('id', 1).single();

                if (error) {
                    if (error.code === 'PGRST116') {
                        console.warn("Tabela vazia. Iniciando limpo.");
                        // N√£o faz nada, state usa os defaults, usuario vai cadastrar
                    } else {
                        console.error("Erro Supabase:", error);
                        alert("Erro ao conectar no banco de dados: " + error.message);
                    }
                } else if (data && data.conteudo) {
                    // SUCESSO: Carrega dados do banco para a mem√≥ria
                    state.users = data.conteudo.users || [];
                    state.goals = data.conteudo.goals || state.goals;
                    state.fine = data.conteudo.fine || state.fine;
                    console.log("Dados carregados:", state.users.length, "participantes");
                }
            } catch (err) {
                console.error("Erro Cr√≠tico:", err);
                alert("Erro cr√≠tico de rede.");
            } finally {
                ui.loading.classList.add('hidden'); // Esconde loading
                if (ui.login.classList.contains('hidden')) renderAll(); // Se j√° logado, renderiza
            }
        }

        async function saveData() {
            // Salva o estado atual no Supabase
            const payload = { users: state.users, goals: state.goals, fine: state.fine };
            
            const btnSave = document.getElementById('btnSave');
            if(btnSave) btnSave.innerText = "Salvando...";

            const { error } = await supabase.from('natal_2026').upsert({ id: 1, tipo: 'dados_gerais', conteudo: payload });

            if (error) {
                alert("Erro ao salvar! " + error.message);
            } else {
                console.log("Salvo com sucesso!");
            }
            if(btnSave) btnSave.innerHTML = '<i class="ph ph-floppy-disk"></i> Salvar Tudo';
        }

        // 7. L√ìGICA DE LOGIN
        function setupLogin() {
            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const u = document.getElementById('loginUser').value.trim();
                const p = document.getElementById('loginPass').value.trim();
                const err = document.getElementById('loginError');

                if (u === 'admin' && p === 'Admin2026') {
                    loginSuccess('admin');
                } else if (u === 'Natal' && p === '2026') {
                    loginSuccess('natal');
                } else {
                    err.innerText = "Dados incorretos";
                }
            });

            document.getElementById('btnLogout').addEventListener('click', () => location.reload());
        }

        function loginSuccess(role) {
            state.currentUser = role;
            ui.login.classList.add('hidden');
            ui.app.classList.remove('hidden');
            
            ui.userBadge.innerText = role === 'admin' ? 'ADMINISTRADOR' : 'VISITANTE';
            ui.userBadge.className = role === 'admin' 
                ? "text-xs font-bold text-emerald-400 border border-emerald-400/30 px-2 py-1 rounded bg-emerald-400/10"
                : "text-xs font-bold text-indigo-400 border border-indigo-400/30 px-2 py-1 rounded bg-indigo-400/10";

            if (role !== 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
            } else {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
            }

            renderAll();
        }

        // 8. RENDERIZA√á√ÉO DA UI
        function renderAll() {
            renderTable();
            renderSummary();
            renderAdminPanel();
        }

        function renderTable() {
            const tbody = ui.tableBody;
            tbody.innerHTML = '';

            if (state.users.length === 0) {
                tbody.innerHTML = `<tr><td colspan="17" class="p-8 text-center text-slate-500">Nenhum participante. Cadastre no menu Configurar.</td></tr>`;
                return;
            }

            // C√°lculos
            const totalGoalAnual = state.goals.reduce((a,b)=>a+b,0);

            state.users.forEach((p, idx) => {
                let htmlMonths = '';
                let totalPaidUser = 0;
                
                // Calcula meta individual (desconto aniversario)
                let personalGoal = totalGoalAnual;
                if(p.birthday > -1) personalGoal -= state.goals[p.birthday];

                // Render Meses
                p.months.forEach((val, mIdx) => {
                    const goal = state.goals[mIdx];
                    let badgeClass = 'bg-none';
                    let content = val > 0 ? val : '-';

                    if (p.birthday == mIdx) {
                        badgeClass = 'bg-birthday'; 
                        content = 'üéÇ';
                        if(val>0) content += ` ${val}`;
                    } else if (goal > 0) {
                        if (val >= goal) badgeClass = 'bg-paid';
                        else if (val > 0) badgeClass = 'bg-partial';
                        else badgeClass = 'bg-missed';
                    } else {
                        if (val > 0) badgeClass = 'bg-paid';
                    }
                    
                    totalPaidUser += val;
                    htmlMonths += `<td class="p-1 text-center"><span class="status-badge ${badgeClass}">${content}</span></td>`;
                });

                totalPaidUser += (p.extra || 0);
                const totalDebt = personalGoal + (p.fine || 0);
                const missing = Math.max(0, totalDebt - totalPaidUser);

                // Avatar
                let avatar = `<div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold border border-slate-600">${p.name[0]}</div>`;
                if(p.photo) avatar = `<img src="${p.photo}" class="w-8 h-8 rounded-full object-cover border border-slate-500">`;

                const row = document.createElement('tr');
                row.className = "hover:bg-slate-700/50 border-b border-slate-700 last:border-0 transition";
                row.innerHTML = `
                    <td class="p-2 sticky-col z-20 font-medium text-white flex items-center gap-3 pl-4">
                        ${avatar} ${p.name}
                    </td>
                    ${htmlMonths}
                    <td class="p-1 text-center bg-rose-900/10 text-rose-400 font-bold text-xs border-l border-white/5">${p.fine>0?p.fine:'-'}</td>
                    <td class="p-1 text-center bg-indigo-900/10 text-indigo-400 font-bold text-xs border-l border-white/5">${p.extra>0?p.extra:'-'}</td>
                    <td class="p-2 text-right bg-white/5 font-mono text-emerald-400 text-xs font-bold">R$ ${totalPaidUser}</td>
                    <td class="p-2 text-right bg-white/5 font-mono text-xs ${missing>0?'text-rose-400':'text-slate-500'}">R$ ${missing}</td>
                    <td class="p-2 text-center sticky right-0 bg-slate-800 z-20 admin-only">
                        <button class="text-indigo-400 hover:text-white p-1 rounded hover:bg-slate-700 btn-edit" data-idx="${idx}"><i class="ph ph-pencil-simple text-lg"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Re-attach edit events
            document.querySelectorAll('.btn-edit').forEach(b => {
                b.addEventListener('click', (e) => openModal(e.currentTarget.dataset.idx));
            });
            
            // Re-apply admin visibility
            if(state.currentUser !== 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
            }
        }

        function renderSummary() {
            const c = document.getElementById('dashboardSummary');
            // C√°lculos totais simples
            const totalUsers = state.users.length;
            let totalPaid = 0;
            let totalFineExtra = 0;
            
            state.users.forEach(p => {
                p.months.forEach(v => totalPaid += v);
                totalPaid += (p.extra || 0);
                totalFineExtra += (p.extra || 0) + (p.fine || 0); // Soma movimenta√ß√£o extra
            });

            c.innerHTML = `
                <div class="card border-l-4 border-l-emerald-500"><p class="text-slate-400 text-[10px] font-bold uppercase">Caixa Total</p><h2 class="text-2xl font-bold text-white mt-1">R$ ${totalPaid.toLocaleString()}</h2></div>
                <div class="card border-l-4 border-l-indigo-500"><p class="text-slate-400 text-[10px] font-bold uppercase">Participantes</p><h2 class="text-2xl font-bold text-white mt-1">${totalUsers}</h2></div>
            `;
        }

        function renderAdminPanel() {
            // Renderiza inputs de metas
            const goalsContainer = document.getElementById('goalsInputs');
            goalsContainer.innerHTML = '';
            state.goals.forEach((val, idx) => {
                goalsContainer.innerHTML += `
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-bold">${MONTHS[idx]}</label>
                        <input type="number" class="input-dark goal-input" data-idx="${idx}" value="${val}">
                    </div>
                `;
            });

            // Inputs de Multa
            document.getElementById('fineDate').value = state.fine.date;
            document.getElementById('fineMin').value = state.fine.min;
            document.getElementById('fineVal').value = state.fine.val;
        }

        // 9. FUN√á√ïES DE MODAL (Edi√ß√£o)
        let editingIdx = -1;
        let tempPhoto = '';

        function openModal(idx) {
            editingIdx = idx;
            const p = state.users[idx];
            document.getElementById('modalTitle').innerText = `Editar: ${p.name}`;
            document.getElementById('modalBirthday').value = p.birthday;
            
            // Foto
            tempPhoto = p.photo || '';
            updateModalPhotoUI();

            // Meses inputs
            const mc = document.getElementById('modalMonths');
            mc.innerHTML = '';
            p.months.forEach((val, i) => {
                mc.innerHTML += `<div><label class="text-[10px] text-slate-500 uppercase">${MONTHS[i]}</label><input type="number" class="input-dark modal-month-input" data-idx="${i}" value="${val}"></div>`;
            });

            document.getElementById('modalFine').value = p.fine || 0;
            document.getElementById('modalExtra').value = p.extra || 0;

            ui.modal.classList.remove('hidden');
            ui.modal.classList.add('flex');
        }

        function updateModalPhotoUI() {
            const img = document.getElementById('modalImg');
            const init = document.getElementById('modalInitial');
            if (tempPhoto) {
                img.src = tempPhoto;
                img.classList.remove('hidden');
                init.classList.add('hidden');
            } else {
                img.classList.add('hidden');
                init.classList.remove('hidden');
            }
        }

        // Upload de foto (converte pra Base64)
        document.getElementById('modalFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    tempPhoto = evt.target.result;
                    updateModalPhotoUI();
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('modalSave').addEventListener('click', () => {
            const p = state.users[editingIdx];
            
            // Salva meses
            document.querySelectorAll('.modal-month-input').forEach(inp => {
                p.months[parseInt(inp.dataset.idx)] = parseFloat(inp.value) || 0;
            });

            p.birthday = parseInt(document.getElementById('modalBirthday').value);
            p.fine = parseFloat(document.getElementById('modalFine').value) || 0;
            p.extra = parseFloat(document.getElementById('modalExtra').value) || 0;
            p.photo = tempPhoto;

            closeModal();
            renderAll();
            saveData(); // Sync nuvem
        });

        window.closeModal = function() {
            ui.modal.classList.add('hidden');
            ui.modal.classList.remove('flex');
        }

        // 10. A√á√ïES DE ADMINISTRA√á√ÉO
        function setupAdminActions() {
            // Adicionar Usu√°rio
            document.getElementById('btnAddUser').addEventListener('click', () => {
                const name = document.getElementById('newName').value.trim();
                if (!name) return alert("Digite um nome");
                
                state.users.push({
                    name: name,
                    months: [0,0,0,0,0,0,0,0,0,0,0,0],
                    fine: 0,
                    extra: 0,
                    photo: '',
                    birthday: -1
                });
                
                document.getElementById('newName').value = '';
                renderAll();
                saveData();
                alert("Usu√°rio adicionado! Clique no l√°pis na tabela para editar foto e detalhes.");
            });

            // Salvar Tudo (Metas e Multas)
            document.getElementById('btnSave').addEventListener('click', () => {
                // Atualiza metas do state
                document.querySelectorAll('.goal-input').forEach(inp => {
                    state.goals[parseInt(inp.dataset.idx)] = parseFloat(inp.value) || 0;
                });
                
                // Atualiza config multa
                state.fine.date = document.getElementById('fineDate').value;
                state.fine.min = parseFloat(document.getElementById('fineMin').value) || 0;
                state.fine.val = parseFloat(document.getElementById('fineVal').value) || 0;

                renderAll();
                saveData();
            });

            // Verificar Multas
            document.getElementById('btnRunFine').addEventListener('click', () => {
                // Compara datas e valores
                // L√≥gica simplificada: Se total pago em meses < Minimo, aplica multa
                // ATEN√á√ÉO: Isso √© irrevers√≠vel nos dados locais at√© editar manual
                let count = 0;
                state.users.forEach(p => {
                    const totalMonthPay = p.months.reduce((a,b)=>a+b,0);
                    if (totalMonthPay < state.fine.min && p.fine === 0) {
                        p.fine = state.fine.val;
                        count++;
                    }
                });
                renderAll();
                saveData();
                alert(`${count} multas aplicadas.`);
            });

            // Reset
            document.getElementById('btnReset').addEventListener('click', async () => {
                if(confirm("TEM CERTEZA? Isso apaga TUDO do banco de dados.")) {
                    state.users = [];
                    renderAll();
                    saveData();
                }
            });
        }

        // 11. ABAS E UTILS
        function setupTabs() {
            ui.tabDash.addEventListener('click', () => switchTab('dashboard'));
            ui.tabAdmin.addEventListener('click', () => switchTab('admin'));
        }

        function switchTab(tab) {
            ui.tabDash.classList.remove('active', 'bg-indigo-600', 'text-white');
            ui.tabAdmin.classList.remove('active', 'bg-indigo-600', 'text-white');
            ui.tabDash.classList.add('text-slate-400');
            ui.tabAdmin.classList.add('text-slate-400');

            if(tab === 'dashboard') {
                ui.tabDash.classList.add('active', 'bg-indigo-600', 'text-white');
                ui.tabDash.classList.remove('text-slate-400');
                ui.viewDash.classList.remove('hidden');
                ui.viewAdmin.classList.add('hidden');
            } else {
                ui.tabAdmin.classList.add('active', 'bg-indigo-600', 'text-white');
                ui.tabAdmin.classList.remove('text-slate-400');
                ui.viewDash.classList.add('hidden');
                ui.viewAdmin.classList.remove('hidden');
            }
        }

        // CSV Import (Simples)
        const csvInput = document.getElementById('csvInput');
        if(csvInput) {
            csvInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const lines = evt.target.result.split('\n');
                    // L√≥gica simplificada de importa√ß√£o: Pega a primeira coluna como nome
                    let imported = 0;
                    lines.forEach((line, idx) => {
                        if (idx > 0) { // Pula header
                            const cols = line.split(',');
                            if (cols[0] && cols[0].trim()) {
                                state.users.push({
                                    name: cols[0].trim(),
                                    months: [0,0,0,0,0,0,0,0,0,0,0,0],
                                    fine: 0, extra: 0, photo: '', birthday: -1
                                });
                                imported++;
                            }
                        }
                    });
                    alert(`${imported} pessoas importadas! Configure os valores no painel.`);
                    renderAll();
                    saveData();
                };
                reader.readAsText(file);
            });
        }

        // Search
        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            const rows = ui.tableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const txt = row.innerText.toLowerCase();
                row.style.display = txt.includes(term) ? '' : 'none';
            });
        });

    </script>
</body>
</html>