<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Natal Fam√≠lia 2026</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÖ</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- √çcones -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Calend√°rio -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>
    
    <!-- SUPABASE (UMD Est√°vel) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { dark: { 900: '#0B0E14', 800: '#151923', 700: '#2A2F3E' } }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0B0E14; color: #E2E8F0; }
        .glass-card { background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); }
        .card { background-color: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; padding: 1.5rem; }
        .tab-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; color: #94a3b8; transition: all 0.2s; }
        .tab-btn:hover { color: white; background-color: #334155; }
        .tab-btn.active { background-color: #4f46e5; color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2); }
        .status-badge { font-size: 0.7rem; font-weight: 700; padding: 2px 0; width: 100%; display: block; border-radius: 4px; text-align: center; }
        .bg-paid { background: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3); }
        .bg-partial { background: rgba(250, 204, 21, 0.15); color: #facc15; border: 1px solid rgba(250, 204, 21, 0.3); }
        .bg-missed { background: rgba(248, 113, 113, 0.15); color: #f87171; border: 1px solid rgba(248, 113, 113, 0.3); }
        .bg-none { background: rgba(148, 163, 184, 0.1); color: #94a3b8; border: 1px dashed rgba(148, 163, 184, 0.2); }
        .bg-birthday { background: linear-gradient(135deg, rgba(236, 72, 153, 0.2), rgba(168, 85, 247, 0.2)); color: #f472b6; border: 1px solid rgba(236, 72, 153, 0.4); display: flex; justify-content: center; align-items: center; }
        .input-dark { background-color: #0f172a; border: 1px solid #334155; color: white; border-radius: 0.5rem; padding: 0.6rem; width: 100%; font-size: 0.875rem; transition: border-color 0.2s; }
        .input-dark:focus { outline: none; border-color: #6366f1; ring: 1px #6366f1; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Sticky Col */
        th.sticky-col, td.sticky-col { position: sticky; left: 0; z-index: 20; background-color: #1e293b; box-shadow: 4px 0 8px rgba(0,0,0,0.2); }
        tr:hover td.sticky-col { background-color: #334155; }
        .profile-pic { object-fit: cover; width: 100%; height: 100%; }
        /* Utils */
        ::-webkit-scrollbar { height: 8px; width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        #loadingOverlay { background: #0f172a; z-index: 200; position: fixed; inset: 0; display: flex; justify-content: center; align-items: center; color: white; flex-direction: column; }
        body.role-user .admin-only { display: none !important; }
        .login-bg { background: radial-gradient(circle at top, #312e81, #0f172a); }
    </style>
</head>
<body class="flex flex-col min-h-screen font-sans">

    <!-- Loading -->
    <div id="loadingOverlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mb-4"></div>
        <p class="text-indigo-400 font-bold animate-pulse">Iniciando Sistema...</p>
        <button onclick="forceStart()" class="mt-8 text-xs text-slate-500 hover:text-white underline">Demorou? Iniciar Vazio</button>
    </div>

    <!-- LOGIN -->
    <div id="loginScreen" class="hidden fixed inset-0 z-[100] login-bg flex flex-col items-center justify-center p-4">
        <div class="relative w-full max-w-md glass-card rounded-2xl overflow-hidden shadow-2xl fade-in p-8">
            <div class="text-center mb-8">
                <div class="inline-flex bg-slate-800/50 p-3 rounded-2xl border border-white/10 shadow-lg mb-4 text-4xl">üéÖ</div>
                <h1 class="text-3xl font-bold text-white tracking-tight">Natal Fam√≠lia 2026</h1>
                <p class="text-slate-400 text-sm mt-2">√Årea Restrita</p>
            </div>
            <form id="loginForm" class="space-y-4">
                <div><label class="text-xs font-bold text-slate-500 uppercase ml-1">Usu√°rio</label><input type="text" id="loginUser" class="input-dark bg-slate-900/50" placeholder="admin" required></div>
                <div><label class="text-xs font-bold text-slate-500 uppercase ml-1">Senha</label><input type="password" id="loginPass" class="input-dark bg-slate-900/50" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required></div>
                <p id="loginError" class="text-rose-400 text-xs text-center font-bold h-4"></p>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl shadow-lg transition-transform transform active:scale-95">ENTRAR</button>
            </form>
        </div>
    </div>

    <!-- APP -->
    <div id="appContent" class="hidden flex flex-col min-h-screen">
        <nav class="bg-slate-800 border-b border-slate-700 sticky top-0 z-50 h-16 shadow-lg">
            <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-rose-600 p-1.5 rounded-lg shadow-lg w-9 h-9 flex items-center justify-center text-xl">üéÖ</div>
                    <h1 class="text-lg font-bold text-white tracking-tight hidden sm:block">Natal 2026</h1>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex bg-slate-900/80 p-1 rounded-lg border border-slate-600">
                        <button onclick="switchTab('dashboard')" id="btn-dashboard" class="tab-btn active">Painel</button>
                        <button onclick="switchTab('admin')" id="btn-admin" class="tab-btn admin-only">Admin</button>
                    </div>
                    <button onclick="handleLogout()" class="text-slate-400 hover:text-white p-2" title="Sair"><i class="ph ph-sign-out text-xl"></i></button>
                </div>
            </div>
        </nav>

        <main class="flex-grow p-4 sm:p-6 w-full max-w-7xl mx-auto space-y-6">
            <!-- DASHBOARD -->
            <div id="view-dashboard" class="fade-in space-y-6">
                <div class="flex flex-col sm:flex-row justify-between items-end sm:items-center gap-4">
                    <div><h2 class="text-xl font-bold text-white">Vis√£o Geral</h2><p class="text-sm text-slate-400" id="statusMsg">Carregado da Nuvem</p></div>
                    <div class="flex gap-2 admin-only">
                        <button onclick="resetData()" class="text-xs text-rose-400 border border-rose-900 px-3 py-1.5 rounded hover:bg-rose-900/20 flex gap-2 items-center"><i class="ph ph-trash"></i> Limpar</button>
                        <button onclick="loadDemoData()" class="text-xs bg-indigo-600 text-white px-3 py-1.5 rounded font-bold hover:bg-indigo-500 flex gap-2 items-center shadow"><i class="ph ph-magic-wand"></i> Gerar Exemplo</button>
                    </div>
                </div>

                <!-- KPIs -->
                <div id="dashboardSummary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>

                <!-- Tabela -->
                <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden shadow-xl">
                    <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900/50">
                        <h3 class="text-sm font-bold text-white flex gap-2"><i class="ph ph-users text-indigo-400"></i> Detalhamento</h3>
                        <input id="searchInput" type="text" placeholder="Buscar..." class="input-dark !w-40 !py-1 !text-xs">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-900 text-slate-400 text-[10px] uppercase font-bold border-b border-slate-700 tracking-wider">
                                    <th class="p-3 sticky-col min-w-[180px] text-slate-300 pl-4">Nome</th>
                                    <th class="p-1 text-center w-12">Jan</th><th class="p-1 text-center w-12">Fev</th><th class="p-1 text-center w-12">Mar</th>
                                    <th class="p-1 text-center w-12">Abr</th><th class="p-1 text-center w-12">Mai</th><th class="p-1 text-center w-12">Jun</th>
                                    <th class="p-1 text-center w-12">Jul</th><th class="p-1 text-center w-12">Ago</th><th class="p-1 text-center w-12">Set</th>
                                    <th class="p-1 text-center w-12">Out</th><th class="p-1 text-center w-12">Nov</th><th class="p-1 text-center w-12">Dez</th>
                                    <th class="p-1 text-center bg-rose-900/10 text-rose-400 w-16 border-l border-white/5">Multa</th>
                                    <th class="p-1 text-center bg-indigo-900/10 text-indigo-400 w-16 border-l border-white/5">Extra</th>
                                    <th class="p-2 text-right bg-white/5 w-20">Total</th>
                                    <th class="p-2 text-right bg-white/5 w-20 border-r border-white/5">Falta</th>
                                    <th class="p-2 text-center w-12 sticky right-0 z-20 bg-slate-800 admin-only">Edit</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="text-xs divide-y divide-slate-700 bg-slate-800">
                                <tr><td colspan="18" class="p-8 text-center text-slate-500 italic">Nenhum registro. <br>Use o bot√£o "Gerar Exemplo" acima ou cadastre em Configurar.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: ADMIN -->
            <div id="viewAdmin" class="hidden space-y-6 fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Config Metas -->
                    <div class="bg-slate-800 border border-slate-700 rounded-xl p-6">
                        <h3 class="font-bold text-white mb-4 flex items-center gap-2"><i class="ph ph-currency-dollar text-indigo-400"></i> Metas Mensais</h3>
                        <div id="goalsInputs" class="grid grid-cols-4 gap-3"></div>
                        <div class="mt-4 pt-4 border-t border-slate-700 flex justify-end">
                            <button onclick="saveAll()" class="bg-indigo-600 text-white px-4 py-2 rounded text-xs font-bold uppercase hover:bg-indigo-500">Salvar Metas</button>
                        </div>
                    </div>
                    <!-- Config Pessoas -->
                    <div class="bg-slate-800 border border-slate-700 rounded-xl p-6">
                        <h3 class="font-bold text-white mb-4 flex items-center gap-2"><i class="ph ph-user-plus text-emerald-400"></i> Adicionar Pessoa</h3>
                        <div class="flex gap-2 mb-4">
                            <input id="newName" type="text" class="input-dark" placeholder="Nome Completo">
                            <button onclick="addUser()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 rounded font-bold shadow">+</button>
                        </div>
                        
                        <div class="space-y-4 pt-4 border-t border-slate-700">
                             <h3 class="font-bold text-white text-sm flex items-center gap-2"><i class="ph ph-siren text-rose-400"></i> Multa Autom√°tica</h3>
                             <div class="grid grid-cols-3 gap-2">
                                <input id="fineDate" type="text" class="input-dark text-center" placeholder="Data">
                                <input id="fineMin" type="number" class="input-dark text-center" placeholder="Min R$">
                                <input id="fineVal" type="number" class="input-dark text-center" placeholder="Multa R$">
                             </div>
                             <button onclick="runFineCheck()" class="w-full bg-rose-900/30 text-rose-300 border border-rose-500/30 py-2 rounded text-xs font-bold uppercase hover:bg-rose-900/50">Verificar Atrasos</button>
                             <p id="fineMsg" class="text-center text-xs text-rose-400 h-4"></p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL EDITAR -->
    <div id="editModal" class="hidden fixed inset-0 z-[100] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-slate-800 border border-slate-600 rounded-xl w-full max-w-lg shadow-2xl transform transition-all scale-100 p-6 space-y-4">
            <div class="flex justify-between items-center border-b border-slate-700 pb-4">
                <h3 class="text-xl font-bold text-white" id="modalTitle">Editar</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white"><i class="ph ph-x text-xl"></i></button>
            </div>
            
            <div class="flex gap-4">
                <div class="w-20 h-20 bg-slate-700 rounded-full flex-shrink-0 overflow-hidden border-2 border-slate-500 relative group cursor-pointer">
                    <img id="modalImg" class="w-full h-full object-cover hidden">
                    <div id="modalInitial" class="w-full h-full flex items-center justify-center text-3xl font-bold text-slate-400">?</div>
                    <input type="file" id="modalFile" class="hidden" accept="image/*">
                    <div onclick="document.getElementById('modalFile').click()" class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center text-white text-xs">FOTO</div>
                </div>
                <div class="flex-grow space-y-2">
                    <label class="text-[10px] uppercase font-bold text-slate-500">M√™s Anivers√°rio</label>
                    <select id="modalBirthday" class="input-dark p-1.5 text-xs">
                        <option value="-1">-- Nenhum --</option>
                        <option value="0">Janeiro</option><option value="1">Fevereiro</option><option value="2">Mar√ßo</option>
                        <option value="3">Abril</option><option value="4">Maio</option><option value="5">Junho</option>
                        <option value="6">Julho</option><option value="7">Agosto</option><option value="8">Setembro</option>
                        <option value="9">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-4 gap-2" id="modalMonths"></div>
            
            <div class="grid grid-cols-2 gap-4 pt-2 border-t border-slate-700">
                <div><label class="text-[10px] text-rose-400 font-bold block mb-1">MULTA (D√çVIDA)</label><input type="number" id="modalFine" class="input-dark border-rose-500/30 text-rose-400 font-bold text-right"></div>
                <div><label class="text-[10px] text-indigo-400 font-bold block mb-1">EXTRA (PAGO)</label><input type="number" id="modalExtra" class="input-dark border-indigo-500/30 text-indigo-400 font-bold text-right"></div>
            </div>

            <button onclick="saveModal()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg shadow-lg">SALVAR ALTERA√á√ïES</button>
        </div>
    </div>

    <!-- SCRIPT PRINCIPAL -->
    <script>
        // CONFIG
        const SUPABASE_URL = 'https://nctjowqvtbejbipxhhd.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5jdGpvd3F1YnRmYmVqaXB4aGhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczODk1NjYsImV4cCI6MjA4Mjk2NTU2Nn0.63GaaShzKx0oO6n4ci0Rj3onmenYycjcE0EN7vVvErE';
        
        // VARI√ÅVEIS
        const MONTHS = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
        let dbClient = null;
        let data = {
            users: [],
            goals: [0,0,30,30,30,30,30,30,30,30,55,55],
            fine: { date: '2026-05-20', min: 50, val: 15 }
        };
        let currentUserRole = null;
        let tempPhoto = '';
        let editingIdx = -1;

        // --- INIT ---
        window.onload = async () => {
            // Inicializa Supabase
            try { dbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } 
            catch(e) { console.error("Erro DB", e); }

            // Configura DatePicker
            flatpickr("#fineDate", { dateFormat: "d/m/Y", defaultDate: data.fine.date });

            // Setup Login
            document.getElementById('loginForm').onsubmit = (e) => {
                e.preventDefault();
                const u = document.getElementById('loginUser').value.trim();
                const p = document.getElementById('loginPass').value.trim();
                if (u === 'admin' && p === 'Admin2026') login('admin');
                else if (u === 'Natal' && p === '2026') login('user');
                else document.getElementById('loginError').innerText = "Dados incorretos";
            };

            // Tenta carregar dados em background enquanto usu√°rio est√° no login
            await fetchData();
        };

        function login(role) {
            currentUserRole = role;
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('appContent').classList.remove('hidden');
            document.body.classList.add(`role-${role}`);
            
            if(role !== 'admin') {
                document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'none');
            }
            renderUI();
        }

        function forceStart() {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function handleLogout() { location.reload(); }

        // --- DADOS ---
        async function fetchData() {
            if(!dbClient) return;
            try {
                const { data: res, error } = await dbClient.from('natal_2026').select('conteudo').eq('id', 1).single();
                if(res && res.conteudo) {
                    data = res.conteudo;
                    // Garante estrutura
                    if(!data.users) data.users = [];
                    if(!data.goals) data.goals = [0,0,30,30,30,30,30,30,30,30,55,55];
                    if(!data.fine) data.fine = { date: '20/05/2026', min: 50, val: 15 };
                    document.getElementById('statusMsg').innerText = "Dados da Nuvem";
                }
            } catch(e) {
                console.warn("Usando dados padr√£o/vazio", e);
                document.getElementById('statusMsg').innerText = "Modo Offline/Novo";
            }
            // Libera tela de login
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        async function saveAll() {
            if(!dbClient) return alert("Erro de conex√£o com banco");
            
            // Pega metas dos inputs se estiver na tela de admin
            const goalInputs = document.querySelectorAll('.goal-input');
            if(goalInputs.length > 0) {
                goalInputs.forEach(i => data.goals[i.dataset.idx] = parseFloat(i.value)||0);
            }
            // Pega config multa
            data.fine.date = document.getElementById('fineDate').value;
            data.fine.min = parseFloat(document.getElementById('fineMin').value)||0;
            data.fine.val = parseFloat(document.getElementById('fineVal').value)||0;

            const { error } = await dbClient.from('natal_2026').upsert({ id: 1, tipo: 'dados_gerais', conteudo: data });
            if(error) alert("Erro ao salvar: " + error.message);
            else {
                // Feedback visual sutil
                const btn = document.getElementById('btnSave');
                if(btn) { btn.innerText = "Salvo!"; setTimeout(()=>btn.innerHTML='<i class="ph ph-floppy-disk"></i> Salvar Tudo', 2000); }
            }
            renderUI();
        }

        function loadDemoData() {
            data.users = [
                { name: 'Adjane', months: [0,0,30,30,30,30,30,30,30,30,55,55], fine: 0, extra: 0, photo: '', birthday: 8 },
                { name: 'Alexia', months: [0,0,30,30,30,30,30,30,30,30,55,55], fine: 0, extra: 0, photo: '', birthday: -1 }
            ];
            renderUI();
            saveAll();
        }

        function resetData() {
            if(confirm("Apagar TUDO?")) {
                data.users = [];
                data.goals = [0,0,0,0,0,0,0,0,0,0,0,0];
                renderUI();
                saveAll();
            }
        }

        // --- RENDER ---
        function renderUI() {
            // 1. Tabela
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            if(data.users.length === 0) {
                tbody.innerHTML = `<tr><td colspan="18" class="p-8 text-center text-slate-500 italic">Nenhum registro.</td></tr>`;
            } else {
                let totalArr = 0, totalEsp = 0, totalFalta = 0;
                
                data.users.forEach((p, idx) => {
                    let htmlMonths = '';
                    let paidSum = 0;
                    let userGoal = data.goals.reduce((a,b)=>a+b,0);
                    
                    // Desconto Anivers√°rio
                    if(p.birthday > -1 && p.birthday < 12) userGoal -= data.goals[p.birthday];

                    p.months.forEach((val, mIdx) => {
                        const goal = data.goals[mIdx];
                        let badge = 'bg-none';
                        let txt = val > 0 ? val : '-';

                        if(p.birthday == mIdx) { badge = 'bg-birthday'; txt = 'üéÇ'; if(val>0) txt+=` ${val}`; }
                        else if(goal > 0) {
                            if(val >= goal) badge = 'bg-paid';
                            else if(val > 0) badge = 'bg-partial';
                            else badge = 'bg-missed';
                        } else {
                             if(val > 0) badge = 'bg-paid';
                        }
                        
                        paidSum += val;
                        htmlMonths += `<td class="p-1 text-center"><span class="status-badge ${badge}">${txt}</span></td>`;
                    });

                    const totalPaid = paidSum + (p.extra || 0);
                    const totalDebt = userGoal + (p.fine || 0);
                    const missing = Math.max(0, totalDebt - totalPaid);

                    // Totais Gerais
                    totalArr += totalPaid;
                    totalEsp += totalDebt;
                    totalFalta += missing;

                    // Avatar
                    let avatar = `<div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold border border-slate-600 text-slate-300">${p.name.charAt(0)}</div>`;
                    if(p.photo && p.photo.length > 50) avatar = `<img src="${p.photo}" class="w-8 h-8 rounded-full object-cover border border-slate-500">`;

                    const row = document.createElement('tr');
                    row.className = "hover:bg-slate-700/50 border-b border-slate-700 last:border-0 transition group";
                    row.innerHTML = `
                        <td class="p-2 sticky-col z-20 font-medium text-white flex items-center gap-3 pl-4">
                            <div class="cursor-pointer hover:scale-110 transition" onclick="openModal(${idx})">${avatar}</div>
                            ${p.name}
                        </td>
                        ${htmlMonths}
                        <td class="p-1 text-center bg-rose-900/10 text-rose-400 font-bold text-xs border-l border-white/5">${p.fine>0?'R$'+p.fine:'-'}</td>
                        <td class="p-1 text-center bg-indigo-900/10 text-indigo-400 font-bold text-xs border-l border-white/5">${p.extra>0?'+'+p.extra:'-'}</td>
                        <td class="p-2 text-right bg-white/5 font-mono text-emerald-400 text-xs font-bold">R$ ${totalPaid}</td>
                        <td class="p-2 text-right bg-white/5 font-mono text-xs ${missing>0?'text-rose-400':'text-slate-500'}">R$ ${missing}</td>
                        <td class="p-2 text-center sticky right-0 z-20 bg-slate-800 admin-only shadow-[-5px_0_10px_rgba(0,0,0,0.3)]">
                            <button onclick="openModal(${idx})" class="text-indigo-400 hover:text-white p-1.5 rounded hover:bg-indigo-600 transition"><i class="ph ph-pencil-simple text-lg"></i></button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                // Cards
                const okCount = data.users.filter(p => {
                    let g = data.goals.reduce((a,b)=>a+b,0);
                    if(p.birthday > -1) g -= data.goals[p.birthday];
                    return ((p.months.reduce((a,b)=>a+b,0) + (p.extra||0)) >= (g + (p.fine||0)));
                }).length;
                
                document.getElementById('dashboardSummary').innerHTML = `
                    <div class="card border-l-4 border-l-emerald-500"><p class="text-slate-400 text-[10px] font-bold uppercase">Caixa Atual</p><h2 class="text-2xl font-bold text-white mt-1">R$ ${totalArr.toLocaleString()}</h2></div>
                    <div class="card border-l-4 border-l-rose-500"><p class="text-slate-400 text-[10px] font-bold uppercase">Falta Receber</p><h2 class="text-2xl font-bold text-white mt-1">R$ ${totalFalta.toLocaleString()}</h2></div>
                    <div class="card border-l-4 border-l-indigo-500"><p class="text-slate-400 text-[10px] font-bold uppercase">Participantes</p><div class="flex items-end gap-2 mt-1"><h2 class="text-2xl font-bold text-white">${data.users.length}</h2><span class="text-xs text-indigo-400 font-bold mb-1 px-2 rounded bg-indigo-900/30">${okCount} Quitados</span></div></div>
                    <div class="card border-l-4 border-l-amber-500"><p class="text-slate-400 text-[10px] font-bold uppercase">Extra Arrecadado</p><h2 class="text-2xl font-bold text-white mt-1">R$ ${data.users.reduce((acc, p) => acc + (p.extra || 0), 0).toLocaleString()}</h2></div>
                `;
            }

            // Admin Panel Inputs
            const goalsContainer = document.getElementById('goalsInputs');
            goalsContainer.innerHTML = '';
            data.goals.forEach((val, idx) => {
                goalsContainer.innerHTML += `
                    <div>
                        <label class="text-[10px] text-slate-500 uppercase font-bold">${MONTHS[idx]}</label>
                        <input type="number" class="input-dark goal-input" data-idx="${idx}" value="${val}">
                    </div>
                `;
            });

            // Atualizar visibilidade Admin se necess√°rio
            if (currentUserRole !== 'admin') {
                document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'none');
            } else {
                 document.querySelectorAll('.admin-only').forEach(e => e.style.display = ''); // Restore default
            }
        }

        // --- FUN√á√ïES ADMIN ---
        function addUser() {
            const name = document.getElementById('newName').value.trim();
            if(!name) return;
            data.users.push({
                name: name,
                months: Array(12).fill(0),
                fine: 0, extra: 0, photo: '', birthday: -1
            });
            document.getElementById('newName').value = '';
            saveAll();
        }

        function runFineCheck() {
            const dStr = document.getElementById('fineDate').value;
            const min = parseFloat(document.getElementById('fineMin').value)||0;
            const val = parseFloat(document.getElementById('fineVal').value)||0;
            
            // Simples check de data string DD/MM/YYYY
            const parts = dStr.split('/');
            const deadline = new Date(parts[2], parts[1]-1, parts[0]);
            const today = new Date();
            
            // Zera horas
            deadline.setHours(23,59,59); today.setHours(0,0,0);

            if(today <= deadline) {
                if(!confirm(`Data limite (${dStr}) ainda n√£o chegou. Aplicar mesmo assim?`)) return;
            }

            let count = 0;
            data.users.forEach(p => {
                const paid = p.months.reduce((a,b)=>a+b,0);
                if(paid < min && p.fine === 0) {
                    p.fine = val;
                    count++;
                }
            });
            
            document.getElementById('fineMsg').innerText = `${count} multas aplicadas.`;
            saveAll();
        }

        // --- MODAL ---
        function openModal(idx) {
            if(currentUserRole !== 'admin') return;
            editingIdx = idx;
            const p = data.users[idx];
            document.getElementById('modalTitle').innerText = p.name;
            document.getElementById('modalBirthday').value = p.birthday;
            
            // Foto
            tempPhoto = p.photo;
            const img = document.getElementById('modalImg');
            const init = document.getElementById('modalInitial');
            if(tempPhoto && tempPhoto.length > 50) { img.src = tempPhoto; img.classList.remove('hidden'); init.classList.add('hidden'); }
            else { img.classList.add('hidden'); init.classList.remove('hidden'); init.innerText = p.name[0]; }

            // Meses
            const mc = document.getElementById('modalMonths');
            mc.innerHTML = '';
            p.months.forEach((val, i) => {
                mc.innerHTML += `<div><label class="text-[9px] text-slate-500 uppercase font-bold">${MONTHS[i]}</label><input type="number" class="input-dark modal-month-input p-1 text-center" data-idx="${i}" value="${val}"></div>`;
            });

            document.getElementById('modalFine').value = p.fine;
            document.getElementById('modalExtra').value = p.extra;

            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
        }

        function saveModal() {
            const p = data.users[editingIdx];
            document.querySelectorAll('.modal-month-input').forEach(i => p.months[parseInt(i.dataset.idx)] = parseFloat(i.value)||0);
            p.fine = parseFloat(document.getElementById('modalFine').value)||0;
            p.extra = parseFloat(document.getElementById('modalExtra').value)||0;
            p.birthday = parseInt(document.getElementById('modalBirthday').value);
            if(tempPhoto && tempPhoto.length > 50) p.photo = tempPhoto;
            
            saveAll();
            closeModal();
        }

        // --- UTILS ---
        function switchTab(t) {
            if(t === 'admin' && currentUserRole !== 'admin') return;
            document.getElementById('viewDashboard').classList.add('hidden');
            document.getElementById('viewAdmin').classList.add('hidden');
            document.getElementById('tabDash').classList.remove('bg-indigo-600','text-white');
            document.getElementById('tabAdmin').classList.remove('bg-indigo-600','text-white');
            document.getElementById('tabDash').classList.add('text-slate-400');
            document.getElementById('tabAdmin').classList.add('text-slate-400');

            if(t === 'dashboard') {
                document.getElementById('viewDashboard').classList.remove('hidden');
                document.getElementById('tabDash').classList.add('bg-indigo-600','text-white');
            } else {
                document.getElementById('viewAdmin').classList.remove('hidden');
                document.getElementById('tabAdmin').classList.add('bg-indigo-600','text-white');
            }
        }

        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            const rows = document.getElementById('tableBody').querySelectorAll('tr');
            rows.forEach(r => {
                const txt = r.innerText.toLowerCase();
                r.style.display = txt.includes(term) ? '' : 'none';
            });
        });

        // Foto Upload
        document.getElementById('modalFile').addEventListener('change', function() {
            if(this.files && this.files[0]) {
                const r = new FileReader();
                r.onload = (e) => {
                    tempPhoto = e.target.result;
                    document.getElementById('modalImg').src = tempPhoto;
                    document.getElementById('modalImg').classList.remove('hidden');
                    document.getElementById('modalInitial').classList.add('hidden');
                };
                r.readAsDataURL(this.files[0]);
            }
        });

    </script>
</body>
</html>